<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ÂçÉÊó©ÁÆóÊï∞„ÇØ„Ç®„Çπ„Éà - 6Âπ¥ÁîüÂàÜÊï∞Áâà</title>
<style>
body{font-family:Arial;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform .3s;margin:20px 0}
.monster.level-up{animation:levelUp 3s}
.monster.correct{animation:correct 1.5s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{0%{transform:scale(1) rotate(0deg);color:#333}20%{transform:scale(1.5) rotate(90deg);color:#ff0;filter:drop-shadow(0 0 20px #ff0)}40%{transform:scale(2) rotate(180deg);color:#f0f;filter:drop-shadow(0 0 30px #f0f)}60%{transform:scale(2.5) rotate(270deg);color:#0ff;filter:drop-shadow(0 0 40px #0ff)}80%{transform:scale(3) rotate(360deg);color:#0f0;filter:drop-shadow(0 0 50px #0f0)}100%{transform:scale(1) rotate(360deg);color:gold;filter:drop-shadow(0 0 20px gold)}}
@keyframes correct{0%{transform:scale(1);color:#333}25%{transform:scale(1.3) rotate(10deg);color:#0f0;filter:drop-shadow(0 0 15px #0f0)}50%{transform:scale(1.5) rotate(-10deg);color:#00ff00;filter:drop-shadow(0 0 25px #00ff00)}75%{transform:scale(1.3) rotate(5deg);color:#32cd32;filter:drop-shadow(0 0 20px #32cd32)}100%{transform:scale(1);color:gold;filter:drop-shadow(0 0 10px gold)}}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2)rotate(-10deg);color:#f00}50%{transform:scale(1.2)rotate(10deg);color:#f00}75%{transform:scale(1.2)rotate(-10deg);color:#f00}100%{transform:scale(1);color:#333}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
.mode-btn{background:#2196f3;padding:15px 30px;font-size:18px;margin:20px}
.mode-btn:hover{background:#1976d2}
.mode-btn.practice{background:#ff9800}
.mode-btn.practice:hover{background:#f57c00}
.mode-btn.select{background:#9c27b0}
.mode-btn.select:hover{background:#7b1fa2}
.mode-btn.hidden{background:#ff6b6b;animation:hiddenPulse 2s infinite}
.mode-btn.hidden:hover{background:#d32f2f}
@keyframes hiddenPulse{0%,100%{transform:scale(1);box-shadow:0 0 10px #ff6b6b}50%{transform:scale(1.05);box-shadow:0 0 20px #ff6b6b}}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
input:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,.3)}
.status{margin:15px 0;font-size:18px}
.progress{background:#e0e0e0;border-radius:10px;margin:15px 0;height:20px;overflow:hidden}
.progress-bar{height:100%;transition:width .3s}
.progress-bar.practice{background:#ff9800}
.progress-bar.summary{background:#f44336}
.progress-bar.select{background:#9c27b0}
.progress-bar.hidden{background:linear-gradient(45deg,#ff6b6b,#ffd700,#4caf50,#2196f3);background-size:400% 400%;animation:hiddenProgress 3s ease infinite}
@keyframes hiddenProgress{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:10px;margin:10px 0;border-radius:8px;font-size:16px}
.mode-info.practice{background:#fff3e0;color:#f57c00;border:2px solid #ff9800}
.mode-info.summary{background:#ffebee;color:#d32f2f;border:2px solid #f44336}
.mode-info.select{background:#f3e5f5;color:#7b1fa2;border:2px solid #9c27b0}
.mode-info.hidden{background:linear-gradient(45deg,#ffebee,#fff3e0,#e8f5e8,#e3f2fd);color:#d32f2f;border:2px solid #ff6b6b;animation:hiddenGlow 2s infinite}
@keyframes hiddenGlow{0%,100%{box-shadow:0 0 10px rgba(255,107,107,0.3)}50%{box-shadow:0 0 20px rgba(255,107,107,0.6)}}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 3s infinite;padding:40px;border-radius:20px;margin:20px}
@keyframes rainbow{0%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}25%{background:linear-gradient(45deg,#a8e6cf,#dcedc1);transform:scale(1.05)}50%{background:linear-gradient(45deg,#ffd93d,#ff6b6b);transform:scale(1.1)}75%{background:linear-gradient(45deg,#74b9ff,#0984e3);transform:scale(1.05)}100%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-sections{display:flex;justify-content:center;gap:20px;margin:20px 0;flex-wrap:wrap}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:15px;min-width:180px}
.answer-section h3{margin:0 0 10px 0;color:#2196f3;font-size:16px}
.fraction-input{display:flex;flex-direction:column;align-items:center;gap:5px;margin:10px 0}
.fraction-input input{width:70px;text-align:center;margin:2px}
.fraction-line{width:80px;height:2px;background:#333;margin:3px 0}
.mixed-input{display:flex;align-items:center;justify-content:center;gap:8px;margin:10px 0}
.mixed-input input{width:50px;text-align:center}
.normal-input{display:flex;flex-direction:column;align-items:center;gap:10px}
.normal-input input{width:100px;text-align:center}
.unit-display{font-size:14px;font-weight:bold;color:#666;margin-top:5px}
.submit-btn{padding:12px 20px;font-size:16px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer}
.submit-btn:hover{background:#45a049}
.comparison-options{display:flex;justify-content:center;gap:15px;margin:20px 0}
.comparison-btn{padding:12px 25px;font-size:16px;background:#e3f2fd;border:2px solid #2196f3;border-radius:8px;cursor:pointer}
.comparison-btn:hover{background:#2196f3;color:white}
.comparison-btn.selected{background:#2196f3;color:white}
.fraction-display{display:inline-block;text-align:center;vertical-align:middle;margin:0 5px}
.fraction-display .numerator{display:block;line-height:1.2}
.fraction-display .denominator{display:block;line-height:1.2}
.fraction-display .fraction-bar{display:block;border-top:2px solid #333;margin:2px 0;min-width:25px}
.level-indicator{display:flex;justify-content:center;gap:8px;margin:15px 0;flex-wrap:wrap}
.level-dot{width:25px;height:25px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
.level-dot.completed{background:#4caf50;color:white}
.level-dot.current{background:#2196f3;color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50}
.error-msg{background:#ffebee;color:#d32f2f;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #f44336}
.almost-msg{background:#fff3e0;color:#f57c00;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #ff9800}
.level-select{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;max-width:600px;margin:20px auto}
.level-btn{padding:15px;background:#e3f2fd;border:2px solid #2196f3;border-radius:10px;cursor:pointer;text-align:center;font-size:14px;transition:all 0.3s}
.level-btn:hover{background:#2196f3;color:white;transform:scale(1.05)}
.level-btn h4{margin:5px 0;font-size:16px}
.level-btn p{margin:5px 0;font-size:12px;opacity:0.8}
.correct-celebration{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1000}
.firework{position:absolute;width:4px;height:4px;background:radial-gradient(circle,#ff0,#f00);border-radius:50%;animation:firework 2s ease-out forwards}
@keyframes firework{0%{transform:scale(1);opacity:1}100%{transform:scale(20);opacity:0}}
.sparkle{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;animation:sparkle 1.5s ease-out infinite}
@keyframes sparkle{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}
.nav-buttons{display:flex;justify-content:center;gap:10px;margin:15px 0;flex-wrap:wrap}
.nav-btn{background:#6c757d;color:white;padding:8px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer}
.nav-btn:hover{background:#5a6268}
.timer{font-size:20px;font-weight:bold;color:#d32f2f;margin:10px 0;padding:10px;background:white;border-radius:8px;border:2px solid #f44336}
.ranking{background:white;border-radius:10px;padding:20px;margin:20px 0;border:2px solid #ffd700}
.ranking h3{color:#d32f2f;margin-bottom:15px}
.ranking-item{display:flex;justify-content:space-between;align-items:center;padding:8px 15px;margin:5px 0;border-radius:5px;background:#f8f9fa}
.ranking-item.current{background:#e8f5e8;border:2px solid #4caf50;font-weight:bold}
.rank-medal{font-size:20px;margin-right:10px}
@keyframes titleGlow{0%,100%{transform:scale(1);box-shadow:0 0 20px #ffd700}50%{transform:scale(1.05);box-shadow:0 0 40px #ffd700,0 0 60px #ff6b6b}}
@keyframes masterCelebration{0%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.5) rotate(90deg);filter:hue-rotate(90deg)}50%{transform:scale(2) rotate(180deg);filter:hue-rotate(180deg)}75%{transform:scale(1.5) rotate(270deg);filter:hue-rotate(270deg)}100%{transform:scale(1) rotate(360deg);filter:hue-rotate(360deg)}}
.master-celebration{animation:masterCelebration 4s ease-in-out}
.hidden-stage-unlock{background:linear-gradient(45deg,#ff6b6b,#ffd700);color:white;font-weight:bold;animation:hiddenUnlock 3s infinite}
@keyframes hiddenUnlock{0%,100%{transform:scale(1);box-shadow:0 0 15px rgba(255,107,107,0.5)}50%{transform:scale(1.1);box-shadow:0 0 30px rgba(255,215,0,0.8)}}
</style>
</head>
<body>
<h1>üßÆ ÂçÉÊó©ÁÆóÊï∞„ÇØ„Ç®„Çπ„Éà - 6Âπ¥ÁîüÂàÜÊï∞Áâà</h1>

<div id="start">
<h2>„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
<div class="info">
<div class="mode-info select"><h3>üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</h3><p>‚Ä¢ Â•Ω„Åç„Å™„É¨„Éô„É´„ÇíÈÅ∏„Çì„ÅßÁ∑¥Áøí<br>‚Ä¢ ‰ΩïÂ∫¶„Åß„ÇÇÊåëÊà¶ÂèØËÉΩ</p></div>
<div class="mode-info practice"><h3>üìö Á∑¥Áøí„É¢„Éº„Éâ</h3><p>‚Ä¢ ÂêÑ„É¨„Éô„É´„Åß5ÂïèÈÄ£Á∂öÊ≠£Ëß£„ÅßÊ¨°„ÅÆ„É¨„Éô„É´„Å∏<br>‚Ä¢ ÈñìÈÅï„Åà„Åü„Çâ„Åù„ÅÆ„É¨„Éô„É´„ÅÆ„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çã</p></div>
<div class="mode-info summary"><h3>üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</h3><p>‚Ä¢ ÂÖ®9„É¨„Éô„É´√óÂêÑ5ÂïèÔºùË®à45Âïè„Å´ÊåëÊà¶<br>‚Ä¢ ‰∏ÄÂïè„Åß„ÇÇÈñìÈÅï„Åà„Çã„Å®„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº<br>‚Ä¢ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ„Åß„É©„É≥„Ç≠„É≥„Ç∞„Å´ÊåëÊà¶ÔºÅ</p></div>
<div id="hiddenModeInfo" class="mode-info hidden" style="display:none"><h3>üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</h3><p>‚Ä¢ Ë∂ÖÈ´òÈõ£Â∫¶„ÅÆÂàÜÊï∞ÂïèÈ°å„Å´ÊåëÊà¶<br>‚Ä¢ ÂÖ®10Âïè„ÇØ„É™„Ç¢„Åß„ÄåÂàÜÊï∞„Éû„Çπ„Çø„Éº„Äç„ÅÆÁß∞Âè∑Áç≤Âæó<br>‚Ä¢ Ê¥æÊâã„Å™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßÁ•ùÁ¶èÔºÅ</p></div>
</div>
<button class="mode-btn select" onclick="showLevelSelect()">üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</button>
<button class="mode-btn practice" onclick="selectMode('practice')">üìö Á∑¥Áøí„É¢„Éº„Éâ</button>
<button class="mode-btn" onclick="selectMode('summary')">üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</button>
<button id="hiddenStageBtn" class="mode-btn hidden" onclick="selectMode('hidden')" style="display:none">üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</button>
</div>

<div id="levelSelect" style="display:none">
<h2>üéÆ „É¨„Éô„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
<div class="level-select">
<div class="level-btn" onclick="selectLevel(1)"><h4>üìä „É¨„Éô„É´1</h4><p>ÂàÜÊï∞√óÊï¥Êï∞</p></div>
<div class="level-btn" onclick="selectLevel(2)"><h4>üî¢ „É¨„Éô„É´2</h4><p>ÂàÜÊï∞√∑Êï¥Êï∞</p></div>
<div class="level-btn" onclick="selectLevel(3)"><h4>üî≤ „É¨„Éô„É´3</h4><p>ÂàÜÊï∞√óÂàÜÊï∞</p></div>
<div class="level-btn" onclick="selectLevel(4)"><h4>üîÑ „É¨„Éô„É´4</h4><p>Â∏ØÂàÜÊï∞√óÂ∏ØÂàÜÊï∞</p></div>
<div class="level-btn" onclick="selectLevel(5)"><h4>‚≠ê „É¨„Éô„É´5</h4><p>ÂàÜÊï∞√óÂàÜÊï∞√óÂàÜÊï∞</p></div>
<div class="level-btn" onclick="selectLevel(6)"><h4>‚öñÔ∏è „É¨„Éô„É´6</h4><p>Â§ßÂ∞èÊØîËºÉ</p></div>
<div class="level-btn" onclick="selectLevel(7)"><h4>üí° „É¨„Éô„É´7</h4><p>ÈÄÜÊï∞</p></div>
<div class="level-btn" onclick="selectLevel(8)"><h4>üèÉ „É¨„Éô„É´8</h4><p>ÊôÇÈñì„ÅÆÂàÜÊï∞</p></div>
<div class="level-btn" onclick="selectLevel(9)"><h4>üëë „É¨„Éô„É´9</h4><p>ÂàÜÊï∞„ÅÆÊñáÁ´†È°å</p></div>
</div>
<button onclick="backToStart()">„Éà„ÉÉ„ÉóÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
</div>

<div id="game" style="display:none">
<div class="info">
<div id="modeDisplay"></div>
<div>„É¨„Éô„É´<span id="lv">1</span>/9 - <span id="lvInfo"></span></div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>
<div id="levelProgress"></div>
</div>

<div id="timerDisplay" class="timer" style="display:none">‚è±Ô∏è ÁµåÈÅéÊôÇÈñì: <span id="timer">00:00</span></div>

<div class="nav-buttons">
<button class="nav-btn" onclick="backToStart()">„Éà„ÉÉ„ÉóÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
<button class="nav-btn" id="levelSelectBtn" onclick="backToLevelSelect()" style="display:none">„É¨„Éô„É´ÈÅ∏Êäû„Å´„ÇÇ„Å©„Çã</button>
</div>

<div class="level-indicator" id="levelIndicator"></div>
<div class="monster" id="monster">üìä</div>
<div class="question" id="q"></div>

<div id="answerSections" class="answer-sections">
<div class="answer-section">
<h3>ÂàÜÊï∞„ÅßÁ≠î„Åà„ÇãÔºàÂøÖ„ÅöÁ¥ÑÂàÜÔºâ</h3>
<div class="fraction-input">
<input type="number" id="n" placeholder="ÂàÜÂ≠ê" min="0">
<div class="fraction-line"></div>
<input type="number" id="d" placeholder="ÂàÜÊØç" min="1">
</div>
<div id="fUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitFraction()">ÂàÜÊï∞„ÅßÁ≠î„Åà„Çã</button>
</div>

<div class="answer-section" id="mixedSection" style="display:none">
<h3>Â∏ØÂàÜÊï∞„ÅßÁ≠î„Åà„ÇãÔºàÂøÖ„ÅöÁ¥ÑÂàÜÔºâ</h3>
<div class="mixed-input">
<input type="number" id="mw" placeholder="Êï¥Êï∞" min="0">
<div class="fraction-input" style="margin:0">
<input type="number" id="mn" placeholder="ÂàÜÂ≠ê" min="0">
<div class="fraction-line"></div>
<input type="number" id="md" placeholder="ÂàÜÊØç" min="1">
</div>
</div>
<div id="mUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitMixed()">Â∏ØÂàÜÊï∞„ÅßÁ≠î„Åà„Çã</button>
</div>

<div class="answer-section">
<h3>Êï¥Êï∞„ÉªÂ∞èÊï∞„ÅßÁ≠î„Åà„Çã</h3>
<div class="normal-input">
<input type="text" id="norm" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ">
<div id="nUnit" class="unit-display" style="display:none"></div>
</div>
<button class="submit-btn" onclick="submitNormal()">Êï¥Êï∞„ÉªÂ∞èÊï∞„ÅßÁ≠î„Åà„Çã</button>
</div>
</div>

<div id="comparisonInput" style="display:none" class="comparison-options">
<button class="comparison-btn" onclick="selectComparison(this, 'left')">Â∑¶„Åå„Çè</button>
<button class="comparison-btn" onclick="selectComparison(this, 'right')">Âè≥„Åå„Çè</button>
<button class="comparison-btn" onclick="selectComparison(this, 'equal')">Âêå„Åò</button>
<br>
<button class="submit-btn" onclick="submitComparison()" style="margin-top:15px">Á≠î„Åà„Çã</button>
</div>

<div id="wrong" style="display:none">
<div id="almostMsg" class="almost-msg" style="display:none"><strong>„Åä„Åó„ÅÑÔºÅÁ¥ÑÂàÜ„Åß„Åç„Åæ„Åô</strong><br><span id="almostText"></span></div>
<div id="wrongMsg" class="error-msg">„Åæ„Å°„Åå„ÅÑ„Åß„Åô„ÄÇ</div>
<div id="correctAnswer" class="correct-answer" style="display:none"><strong>Ê≠£Ëß£Ôºö</strong><span id="correctText"></span></div>
<div id="practiceMsg" style="display:none"><p>„Åì„ÅÆ„É¨„Éô„É´„ÅÆ„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çä„Åæ„Åô„ÄÇÈ†ëÂºµ„Å£„Å¶ÔºÅ</p></div>
<div id="selectMsg" style="display:none"><p>„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p></div>
<button onclick="retry()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
<button onclick="next()">„Å§„Åé„Å∏</button>
<button id="backToSelectBtn" onclick="backToLevelSelect()" style="display:none">„É¨„Éô„É´ÈÅ∏Êäû„Å´Êàª„Çã</button>
</div>

<div class="status">
<span>„Çπ„Ç≥„Ç¢: <span id="score">0</span></span>
<span id="totalQ" style="display:none"> / 45Âïè‰∏≠</span>
<span id="hiddenQ" style="display:none"> / 10Âïè‰∏≠</span>
</div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h1>
<div class="monster" style="font-size:120px">üòµ</div>
<h2>ÊÆãÂøµÔºÅ</h2>
<div class="info">
<p>Âà∞ÈÅî„É¨„Éô„É´: <span id="finalLv"></span>/9</p>
<p>Ê≠£Ëß£Êï∞: <span id="finalScore1"></span>Âïè</p>
<p id="finalTime" style="display:none">ÁµåÈÅéÊôÇÈñì: <span id="finalTimeValue"></span></p>
</div>
<button onclick="restart()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>üéâ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ üéâ</h1>
<div class="monster" style="font-size:120px">üëë</div>
<h2>„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅÂÖ®„É¨„Éô„É´Âà∂Ë¶áÔºÅ</h2>
<div class="info">
<p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore2"></span>ÂïèÊ≠£Ëß£</p>
<p id="clearTime">„ÇØ„É™„Ç¢ÊôÇÈñì: <span id="clearTimeValue"></span></p>
</div>
<div id="rankingDisplay" class="ranking" style="display:none">
<h3>üèÜ „É©„É≥„Ç≠„É≥„Ç∞</h3>
<div id="rankingList"></div>
</div>
<div id="hiddenStageUnlock" class="hidden-stage-unlock" style="display:none;padding:20px;margin:20px;border-radius:15px;">
<h3>üåü Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÅåËß£Êîæ„Åï„Çå„Åæ„Åó„ÅüÔºÅ üåü</h3>
<p>„Éà„ÉÉ„ÉóÁîªÈù¢„Åã„Çâ„ÄåÈö†„Åó„Çπ„ÉÜ„Éº„Ç∏„Äç„Å´ÊåëÊà¶„Åß„Åç„Åæ„ÅôÔºÅ</p>
</div>
<button onclick="restart()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
</div>

<div id="hiddenClear" style="display:none">
<div style="background:linear-gradient(45deg,#ff9a9e,#fecfef,#a8e6cf,#dcedc1);padding:40px;border-radius:20px;animation:rainbow 3s infinite;">
<h1>üåü Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ üåü</h1>
<div class="monster master-celebration" style="font-size:150px;">üëë</div>
<h2>üèÜ ÂàÜÊï∞„Éû„Çπ„Çø„ÉºË™ïÁîüÔºÅ üèÜ</h2>
<p style="font-size:20px;color:#d32f2f;font-weight:bold;">„ÅÇ„Å™„Åü„ÅØÁúü„ÅÆÂàÜÊï∞„ÅÆÈÅî‰∫∫„Åß„ÅôÔºÅ</p>
<div style="margin:20px 0;font-size:18px;">
<p>Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏ÂÖ®10ÂïèÂÆåÂÖ®Âà∂Ë¶á</p>
<p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="hiddenFinalScore"></span>ÂïèÊ≠£Ëß£</p>
</div>
<button onclick="restart()" style="padding:15px 30px;font-size:20px;background:#4CAF50;color:white;border:none;border-radius:10px;cursor:pointer;">„Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
</div>
</div>

<div id="celebration" class="correct-celebration"></div>

<script>
// ÂÆâÂÖ®„Å™Ë¶ÅÁ¥†ÂèñÂæóÈñ¢Êï∞
function $(id) {
    const el = document.getElementById(id);
    if (!el) {
        console.warn(`Element ${id} not found`);
        return {
            style: {},
            textContent: '',
            innerHTML: '',
            value: '',
            classList: {add:()=>{}, remove:()=>{}, contains:()=>false},
            appendChild: ()=>{},
            remove: ()=>{},
            focus: ()=>{}
        };
    }
    return el;
}

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÅÆÂàùÊúüÂåñ
let state = {
    score: 0,
    level: 1,
    prob: null,
    unit: "",
    mode: "",
    lvCount: 0,
    totalQ: 0,
    qNum: 0,
    completed: new Set(),
    selectedComparison: null,
    selectQCount: 0,
    startTime: null,
    timerInterval: null,
    hiddenQ: 0
};

const monsters = ["üìä","üî¢","üî≤","üîÑ","‚≠ê","‚öñÔ∏è","üí°","üèÉ","üëë"];
const lvNames = ["ÂàÜÊï∞√óÊï¥Êï∞","ÂàÜÊï∞√∑Êï¥Êï∞","ÂàÜÊï∞√óÂàÜÊï∞","Â∏ØÂàÜÊï∞√óÂ∏ØÂàÜÊï∞","ÂàÜÊï∞√óÂàÜÊï∞√óÂàÜÊï∞","Â§ßÂ∞èÊØîËºÉ","ÈÄÜÊï∞","ÊôÇÈñì„ÅÆÂàÜÊï∞","ÂàÜÊï∞„ÅÆÊñáÁ´†È°å"];

let hiddenStageUnlocked = false;
try {
    hiddenStageUnlocked = localStorage.getItem('hiddenStageUnlocked') === 'true';
} catch(e) {
    console.warn('LocalStorage not available');
}

const titles = {
    fractionMaster: {
        name: "ÂàÜÊï∞„Éû„Çπ„Çø„Éº",
        description: "Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÇíÂà∂Ë¶á„Åó„ÅüÁúü„ÅÆÂàÜÊï∞„ÅÆÈÅî‰∫∫",
        unlocked: false
    }
};

// ÂàùÊúüÂåñ
window.addEventListener('load', function() {
    if (hiddenStageUnlocked) {
        $("hiddenStageBtn").style.display = "inline-block";
        $("hiddenModeInfo").style.display = "block";
    }
});

// Êï∞Â≠¶Èñ¢Êï∞
const gcd = (a,b) => b ? gcd(b,a%b) : a;
const R = (min,max) => Math.floor(Math.random()*(max-min+1))+min;

function simplify(n,d) {
    if(d<0){n=-n;d=-d}
    const g=gcd(Math.abs(n),Math.abs(d));
    return[n/g,d/g];
}

function randFrac(maxN=10,maxD=10) {
    let n,d;
    do{n=R(1,maxN);d=R(2,maxD)}while(gcd(n,d)!==1||n>=d);
    return[n,d];
}

function frac(n,d) {
    return`<span class="fraction-display"><span class="numerator">${n}</span><span class="fraction-bar"></span><span class="denominator">${d}</span></span>`;
}

function mixedFrac(w,n,d) {
    if(n>=d){w+=Math.floor(n/d);n=n%d}
    return n===0?`${w}`:`${w} ${frac(n,d)}`;
}

function formatAnswer(n,d,u="") {
    const[sn,sd]=simplify(n,d);
    return sd===1?sn+u:`${sn}/${sd}`+u;
}

function formatTime(s) {
    const m=Math.floor(s/60);
    return`${m.toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
}

// „Çø„Ç§„Éû„ÉºÈñ¢Êï∞
function startTimer() {
    if(state.mode==='summary'||state.mode==='hidden'){
        state.startTime=Date.now();
        $("timerDisplay").style.display="block";
        state.timerInterval=setInterval(updateTimer,1000);
    }
}

function updateTimer() {
    if(state.startTime){
        const elapsed=Math.floor((Date.now()-state.startTime)/1000);
        $("timer").textContent=formatTime(elapsed);
    }
}

function stopTimer() {
    if(state.timerInterval){
        clearInterval(state.timerInterval);
        state.timerInterval=null;
    }
}

function getElapsedTime() {
    return state.startTime?Math.floor((Date.now()-state.startTime)/1000):0;
}

// „É©„É≥„Ç≠„É≥„Ç∞Ê©üËÉΩ
function saveRanking(time) {
    try {
        let rankings=JSON.parse(localStorage.getItem('fractionQuestRankings')||'[]');
        rankings.push({time,date:new Date().toISOString()});
        rankings.sort((a,b)=>a.time-b.time);
        rankings=rankings.slice(0,100);
        localStorage.setItem('fractionQuestRankings',JSON.stringify(rankings));
        return rankings;
    } catch(e) {
        return [];
    }
}

function displayRanking(currentTime) {
    const rankings=saveRanking(currentTime);
    const currentRank=rankings.findIndex(r=>r.time===currentTime)+1;
    $("rankingDisplay").style.display="block";
    const rankingList=$("rankingList");
    rankingList.innerHTML="";
    const myRankDiv=document.createElement("div");
    myRankDiv.className="ranking-item current";
    myRankDiv.innerHTML=`<span><strong>„ÅÇ„Å™„Åü„ÅÆÈ†Ü‰Ωç: ${currentRank}‰Ωç</strong></span><span><strong>${formatTime(currentTime)}</strong></span>`;
    rankingList.appendChild(myRankDiv);
    const medals=["ü•á","ü•à","ü•â"];
    for(let i=0;i<Math.min(3,rankings.length);i++){
        const rankDiv=document.createElement("div");
        rankDiv.className="ranking-item";
        if(i===currentRank-1)rankDiv.classList.add("current");
        rankDiv.innerHTML=`<span><span class="rank-medal">${medals[i]}</span>${i+1}‰Ωç</span><span>${formatTime(rankings[i].time)}</span>`;
        if(i<currentRank-1||currentRank>3)rankingList.appendChild(rankDiv);
    }
}

// „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Èñ¢Êï∞
function createFireworks() {
    const celebration=$("celebration");
    celebration.innerHTML="";
    for(let i=0;i<15;i++){
        setTimeout(()=>{
            const firework=document.createElement("div");
            firework.className="firework";
            firework.style.left=Math.random()*window.innerWidth+"px";
            firework.style.top=Math.random()*window.innerHeight+"px";
            firework.style.background=`radial-gradient(circle, hsl(${Math.random()*360}, 100%, 50%), hsl(${Math.random()*360}, 100%, 70%))`;
            celebration.appendChild(firework);
            setTimeout(()=>firework.remove(),2000);
        },i*100);
    }
    for(let i=0;i<30;i++){
        setTimeout(()=>{
            const sparkle=document.createElement("div");
            sparkle.className="sparkle";
            sparkle.style.left=Math.random()*window.innerWidth+"px";
            sparkle.style.top=Math.random()*window.innerHeight+"px";
            celebration.appendChild(sparkle);
            setTimeout(()=>sparkle.remove(),1500);
        },i*50);
    }
}

function createMasterFireworks() {
    const celebration=$("celebration");
    celebration.innerHTML="";
    for(let i=0;i<50;i++){
        setTimeout(()=>{
            const firework=document.createElement("div");
            firework.className="firework";
            firework.style.left=Math.random()*window.innerWidth+"px";
            firework.style.top=Math.random()*window.innerHeight+"px";
            firework.style.background=`radial-gradient(circle, hsl(${Math.random()*360}, 100%, 50%), hsl(${(Math.random()*360+180)%360}, 100%, 70%))`;
            firework.style.animation=`firework ${2+Math.random()}s ease-out forwards`;
            celebration.appendChild(firework);
            setTimeout(()=>firework.remove(),3000);
        },i*50);
    }
    for(let i=0;i<100;i++){
        setTimeout(()=>{
            const star=document.createElement("div");
            star.innerHTML="‚≠ê";
            star.style.position="absolute";
            star.style.left=Math.random()*window.innerWidth+"px";
            star.style.top=Math.random()*window.innerHeight+"px";
            star.style.fontSize=(10+Math.random()*20)+"px";
            star.style.animation=`sparkle ${1+Math.random()}s ease-out infinite`;
            star.style.pointerEvents="none";
            celebration.appendChild(star);
            setTimeout(()=>star.remove(),3000);
        },i*30);
    }
}

// Áß∞Âè∑„Ç∑„Çπ„ÉÜ„É†
function unlockTitle(titleKey) {
    if(titles[titleKey]){
        titles[titleKey].unlocked=true;
        try {
            localStorage.setItem(`title_${titleKey}`,'true');
        } catch(e) {}
        showTitleUnlock(titles[titleKey]);
    }
}

function showTitleUnlock(title) {
    const titleDiv=document.createElement('div');
    titleDiv.innerHTML=`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;display:flex;align-items:center;justify-content:center"><div style="background:linear-gradient(45deg,#ffd700,#ffed4e);padding:40px;border-radius:20px;text-align:center;border:5px solid #ff6b6b;animation:titleGlow 2s infinite"><h1 style="color:#d32f2f;font-size:36px;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,0.5)">üèÜ Áß∞Âè∑Áç≤ÂæóÔºÅ üèÜ</h1><div style="font-size:48px;margin:20px 0">üëë</div><h2 style="color:#1976d2;font-size:28px;margin:10px 0">${title.name}</h2><p style="color:#333;font-size:16px;margin:0">${title.description}</p><button onclick="this.parentElement.parentElement.remove()" style="margin-top:20px;padding:12px 24px;font-size:18px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer">Á¢∫Ë™ç</button></div></div>`;
    document.body.appendChild(titleDiv);
}

// ÂïèÈ°åÁîüÊàê
function generateHiddenProblem() {
    const patterns=[
        ()=>{
            const[n1,d1]=randFrac(12,15);
            const[n2,d2]=randFrac(12,15);
            const[n3,d3]=randFrac(8,12);
            return{q:`${frac(n1,d1)} √ó ${frac(n2,d2)} √∑ ${frac(n3,d3)} =`,n:n1*n2*d3,d:d1*d2*n3,type:'fraction',mixed:true};
        },
        ()=>{
            const w1=R(2,5),d1=R(4,8),n1=R(1,d1-1);
            const w2=R(1,4),d2=R(3,7),n2=R(1,d2-1);
            const w3=R(1,3),d3=R(2,6),n3=R(1,d3-1);
            const i1=w1*d1+n1,i2=w2*d2+n2,i3=w3*d3+n3;
            return{q:`${mixedFrac(w1,n1,d1)} √ó ${mixedFrac(w2,n2,d2)} √∑ ${mixedFrac(w3,n3,d3)} =`,n:i1*i2*d3,d:d1*d2*i3,type:'fraction',mixed:true};
        },
        ()=>{
            const total=R(24,48);
            const[n1,d1]=randFrac(6,12);
            const[n2,d2]=randFrac(4,8);
            return{q:`${total}ÂÄã„ÅÆ„ÅäËèìÂ≠ê„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊúÄÂàù„Å´ÂÖ®‰Ωì„ÅÆ${frac(n1,d1)}„ÇíÈ£ü„Åπ„ÄÅÊÆã„Çä„ÅÆ${frac(n2,d2)}„Çí„Åï„Çâ„Å´È£ü„Åπ„Åæ„Åó„Åü„ÄÇÊúÄÂæå„Å´ÊÆã„Å£„Åü„ÅäËèìÂ≠ê„ÅØ‰ΩïÂÄã„Åß„Åô„ÅãÔºü`,n:total*(d1*d2-n1*d2-(d1-n1)*n2),d:d1*d2,u:"ÂÄã",type:'fraction',mixed:true};
        }
    ];
    return patterns[R(0,2)]();
}

function generateProblem(lv) {
    if(state.mode==='hidden')return generateHiddenProblem();
    switch(lv){
        case 1:{const[n,d]=randFrac(9,12);const i=R(2,8);return{q:`${frac(n,d)} √ó ${i} =`,n:n*i,d:d,type:'fraction',mixed:false}}
        case 2:{const[n,d]=randFrac(8,10);const i=R(2,6);return{q:`${frac(n,d)} √∑ ${i} =`,n:n,d:d*i,type:'fraction',mixed:false}}
        case 3:{const[n1,d1]=randFrac(8,12);const[n2,d2]=randFrac(8,12);return{q:`${frac(n1,d1)} √ó ${frac(n2,d2)} =`,n:n1*n2,d:d1*d2,type:'fraction',mixed:false}}
        case 4:{const w1=R(1,3),d1=R(3,6),n1=R(1,d1-1);const w2=R(1,2),d2=R(3,5),n2=R(1,d2-1);const i1=w1*d1+n1,i2=w2*d2+n2;return{q:`${mixedFrac(w1,n1,d1)} √ó ${mixedFrac(w2,n2,d2)} =`,n:i1*i2,d:d1*d2,type:'fraction',mixed:true}}
        case 5:{const[n1,d1]=randFrac(6,8);const[n2,d2]=randFrac(6,8);const[n3,d3]=randFrac(6,8);return{q:`${frac(n1,d1)} √ó ${frac(n2,d2)} √ó ${frac(n3,d3)} =`,n:n1*n2*n3,d:d1*d2*d3,type:'fraction',mixed:false}}
        case 6:{const[n1,d1]=randFrac(8,12);const[n2,d2]=randFrac(8,12);const v1=n1/d1,v2=n2/d2;const mult=R(2,4);const patterns=[{e1:`${frac(n1,d1)} √ó ${frac(n2,d2)}`,e2:`${frac(n1,d1)}`,v1:v1*v2,v2:v1},{e1:`${frac(n1,d1)} √ó ${mult}`,e2:`${frac(n1,d1)}`,v1:v1*mult,v2:v1}];const p=patterns[R(0,1)];return{q:`${p.e1} „Å® ${p.e2} „Å©„Å°„Çâ„ÅåÂ§ß„Åç„ÅÑ„Åß„Åô„ÅãÔºü<br><small>Ôºà1:Â∑¶„Åå„Çè 2:Âè≥„Åå„Çè 3:Âêå„ÅòÔºâ</small>`,a:Math.abs(p.v1-p.v2)<0.0001?'equal':p.v1>p.v2?'left':'right',type:'comparison',mixed:false}}
        case 7:{const[n,d]=randFrac(8,12);return{q:`${frac(n,d)} „ÅÆÈÄÜÊï∞„ÇíÊ±Ç„ÇÅ„Åæ„Åó„Çá„ÅÜ`,n:d,d:n,type:'fraction',mixed:false}}
        case 8:{const patterns=[()=>{const m=R(10,50);return{q:`${m}ÂàÜ„ÅØ‰ΩïÊôÇÈñì„Åß„Åô„ÅãÔºü`,n:m,d:60,u:"ÊôÇÈñì",type:'fraction',mixed:false}},()=>{const s=R(15,120);return{q:`${s}Áßí„ÅØ‰ΩïÂàÜ„Åß„Åô„ÅãÔºü`,n:s,d:60,u:"ÂàÜ",type:'fraction',mixed:false}},()=>{const h=R(6,20);return{q:`${h}ÊôÇÈñì„ÅØ‰ΩïÊó•„Åß„Åô„ÅãÔºü`,n:h,d:24,u:"Êó•",type:'fraction',mixed:false}}];return patterns[R(0,2)]()}
        case 9:{const patterns=[()=>{const t=R(12,24);const[n,d]=randFrac(4,8);return{q:`${t}ÂÄã„ÅÆ„ÅäËèìÂ≠ê„ÅÆ${frac(n,d)}„ÅØ‰ΩïÂÄã„Åß„Åô„ÅãÔºü`,n:t*n,d:d,u:"ÂÄã",type:'fraction',mixed:true}},()=>{const t=R(6,15);const div=R(2,5);return{q:`${t}ÂÄã„ÅÆ„Çä„Çì„Åî„Çí${div}‰∫∫„ÅßÁ≠â„Åó„ÅèÂàÜ„Åë„Çã„Å®„ÄÅ1‰∫∫„ÅÇ„Åü„Çä‰ΩïÂÄã„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü`,n:t,d:div,u:"ÂÄã",type:'fraction',mixed:true}},()=>{const[n,d]=randFrac(6,10);const w=R(8,20);return{q:`${w}m„ÅÆ„É™„Éú„É≥„ÅÆ${frac(n,d)}„ÅÆÈï∑„Åï„ÅØ‰Ωïm„Åß„Åô„ÅãÔºü`,n:w*n,d:d,u:"m",type:'fraction',mixed:false}}];return patterns[R(0,2)]()}
        default:return generateProblem(1);
    }
}

// UIÂà∂Âæ°Èñ¢Êï∞
function showLevelSelect() {
    $("start").style.display="none";
    $("levelSelect").style.display="block";
}

function backToStart() {
    stopTimer();
    ["start","levelSelect","game","gameover","clear","hiddenClear"].forEach(id=>$(id).style.display="none");
    $("start").style.display="block";
    $("timerDisplay").style.display="none";
}

function restart() {
    backToStart();
}

function selectLevel(lv) {
    state={score:0,level:lv,prob:null,unit:"",mode:"select",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedComparison:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0};
    $("levelSelect").style.display="none";
    $("game").style.display="block";
    updateDisplay();
    updateLevelIndicator();
    nextQ();
}

function backToLevelSelect() {
    stopTimer();
    $("game").style.display="none";
    $("levelSelect").style.display="block";
    $("timerDisplay").style.display="none";
}

function selectMode(m) {
    if(m==='hidden')state={score:0,level:10,prob:null,unit:"",mode:"hidden",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedComparison:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0};
    else state={score:0,level:1,prob:null,unit:"",mode:m,lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedComparison:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0};
    $("start").style.display="none";
    $("game").style.display="block";
    updateDisplay();
    updateLevelIndicator();
    if(m==='summary'||m==='hidden')startTimer();
    nextQ();
}

function updateDisplay() {
    if(state.mode==='hidden'){
        $("lv").textContent="Èö†„Åó";
        $("lvInfo").textContent="Ë∂ÖÈ´òÈõ£Â∫¶„Çπ„ÉÜ„Éº„Ç∏";
        $("monster").textContent="üëë";
    } else {
        $("lv").textContent=state.level;
        $("lvInfo").textContent=lvNames[state.level-1];
        $("monster").textContent=monsters[state.level-1];
    }
    $("score").textContent=state.score;
    $("levelSelectBtn").style.display=state.mode==='select'?"inline-block":"none";
    const bar=$("progressBar");
    if(state.mode==='practice'){
        $("modeDisplay").innerHTML='<div class="mode-info practice"><strong>üìö Á∑¥Áøí„É¢„Éº„Éâ</strong></div>';
        $("levelProgress").textContent=`„Åì„ÅÆ„É¨„Éô„É´: ${state.lvCount}/5ÂïèÊ≠£Ëß£`;
        bar.className="progress-bar practice";
        bar.style.width=`${(state.lvCount/5)*100}%`;
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
    }else if(state.mode==='select'){
        $("modeDisplay").innerHTML='<div class="mode-info select"><strong>üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</strong></div>';
        $("levelProgress").textContent=`ÂïèÈ°åÊï∞: ${state.selectQCount}Âïè`;
        bar.className="progress-bar select";
        bar.style.width=`${Math.min((state.selectQCount/10)*100,100)}%`;
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
    }else if(state.mode==='hidden'){
        $("modeDisplay").innerHTML='<div class="mode-info hidden"><strong>üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</strong></div>';
        $("levelProgress").textContent=`ÂïèÈ°å ${state.hiddenQ+1}/10`;
        bar.className="progress-bar hidden";
        bar.style.width=`${(state.hiddenQ/10)*100}%`;
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="inline";
        $("hiddenQ").textContent=" / 10Âïè‰∏≠";
    }else{
        $("modeDisplay").innerHTML='<div class="mode-info summary"><strong>üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</strong></div>';
        $("levelProgress").textContent=`ÂïèÈ°å ${state.totalQ+1}/45`;
        bar.className="progress-bar summary";
        bar.style.width=`${(state.totalQ/45)*100}%`;
        $("totalQ").style.display="inline";
        $("totalQ").textContent=" / 45Âïè‰∏≠";
        $("hiddenQ").style.display="none";
    }
}

function updateLevelIndicator() {
    const ind=$("levelIndicator");
    if(state.mode==='hidden'){ind.innerHTML="";return}
    ind.innerHTML="";
    for(let i=1;i<=9;i++){
        const dot=document.createElement("div");
        dot.className="level-dot";
        dot.textContent=i;
        if(state.completed.has(i))dot.classList.add("completed");
        else if(i===state.level)dot.classList.add("current");
        ind.appendChild(dot);
    }
}

function nextQ() {
    if(state.mode==='hidden'){
        if(state.hiddenQ>=10){showHiddenClear();return}
    }else if(state.mode==='practice'){
        if(state.lvCount>=5){
            state.completed.add(state.level);
            if(state.level>=9){showClear();return}
            state.level++;state.lvCount=0;
            animate("level-up");updateLevelIndicator();
        }
    }else if(state.mode!=='select'){
        if(state.level>=9&&state.qNum>=5){showClear();return}
        if(state.qNum>=5){
            state.completed.add(state.level);
            state.level++;state.qNum=0;
            animate("level-up");updateLevelIndicator();
        }
    }
    state.prob=generateProblem(state.level);
    state.selectedComparison=null;
    $("q").innerHTML=state.prob.q;
    state.unit=state.prob.u||"";
    clearInputs();
    $("wrong").style.display="none";
    if(state.prob.type==='comparison'){
        $("answerSections").style.display="none";
        $("comparisonInput").style.display="block";
        document.querySelectorAll('.comparison-btn').forEach(btn=>btn.classList.remove('selected'));
    }else{
        $("answerSections").style.display="flex";
        $("comparisonInput").style.display="none";
    }
    $("mixedSection").style.display=state.prob.mixed?"block":"none";
    const show=state.unit?"block":"none";
    ["fUnit","mUnit","nUnit"].forEach(id=>{$(id).textContent=state.unit;$(id).style.display=show});
    updateDisplay();
    setFocus();
}

function clearInputs() {
    ["n","d","mw","mn","md","norm"].forEach(id=>$(id).value="");
}

function animate(cls) {
    $("monster").classList.add(cls);
    if(cls==="correct")createFireworks();
    setTimeout(()=>$("monster").classList.remove(cls),cls==="level-up"?3000:1500);
}

function setFocus() {
    setTimeout(()=>{
        if(state.prob?.type!=='comparison'){
            const input=$("mixedSection").style.display==="block"?$("md"):$("d");
            input.focus();
        }
    },150);
}

// ÂÖ•ÂäõÂá¶ÁêÜ
function selectComparison(btn,choice) {
    document.querySelectorAll('.comparison-btn').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    state.selectedComparison=choice;
}

function submitFraction() {
    const num=parseInt($("n").value)||0;
    const den=parseInt($("d").value)||1;
    if(den===0){showError("ÂàÜÊØç„ÅØ0„Å´„Åß„Åç„Åæ„Åõ„Çì");return}
    if(num===0&&den===1){showError("ÂàÜÂ≠ê„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");return}
    checkAnswer(num,den);
}

function submitMixed() {
    const w=parseInt($("mw").value)||0;
    const num=parseInt($("mn").value)||0;
    const den=parseInt($("md").value)||1;
    if(num===0&&w===0){showError("Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");return}
    if(den===0){showError("ÂàÜÊØç„ÅØ0„Å´„Åß„Åç„Åæ„Åõ„Çì");return}
    if(num>=den&&den>0&&num>0){showError("Â∏ØÂàÜÊï∞„ÅÆÂàÜÂ≠ê„ÅØÂàÜÊØç„Çà„ÇäÂ∞è„Åï„Åè„Åó„Å¶„Åè„Å†„Åï„ÅÑ");return}
    checkAnswer(w*den+num,den);
}

function submitNormal() {
    const ans=$("norm").value.trim();
    if(!ans){showError("Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");return}
    const userDec=parseFloat(ans);
    const correctDec=state.prob.n/state.prob.d;
    const isCorrect=!isNaN(userDec)&&Math.abs(userDec-correctDec)<0.0001;
    handleAnswer(isCorrect,formatAnswer(state.prob.n,state.prob.d,state.unit));
}

function submitComparison() {
    if(!state.selectedComparison){showError("ÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ");return}
    handleAnswer(state.selectedComparison===state.prob.a,"ÊØîËºÉÂïèÈ°å");
}

function checkAnswer(un,ud) {
    const[cn,cd]=simplify(state.prob.n,state.prob.d);
    const[sn,sd]=simplify(un,ud);
    const userGcd=gcd(Math.abs(un),Math.abs(ud));
    const needsSimplification=userGcd>1;
    const isCorrect=sn===cn&&sd===cd&&!needsSimplification;
    const correctAns=formatAnswer(cn,cd,state.unit);
    if(needsSimplification){
        const[rn,rd]=simplify(un,ud);
        $("almostMsg").style.display="block";
        $("almostText").textContent=`${un}/${ud} = ${rn}/${rd}`;
        handleAnswer(false,correctAns);return;
    }
    handleAnswer(isCorrect,correctAns);
}

function handleAnswer(isCorrect,correctAns) {
    if(isCorrect){
        state.score++;
        if(state.mode==='practice')state.lvCount++;
        else if(state.mode==='select')state.selectQCount++;
        else if(state.mode==='hidden')state.hiddenQ++;
        else{state.qNum++;state.totalQ++}
        animate("correct");
        setTimeout(nextQ,2000);
    }else{
        $("wrong").style.display="block";
        if(state.prob.type!=='comparison'){
            $("correctAnswer").style.display="block";
            $("correctText").textContent=correctAns;
        }
        if(state.mode==='practice'){
            state.lvCount=0;
            $("practiceMsg").style.display="block";
        }else if(state.mode==='select'){
            $("selectMsg").style.display="block";
            $("backToSelectBtn").style.display="inline-block";
        }else{
            showGameOver();return;
        }
        animate("wrong");
    }
}

function showError(msg) {
    $("wrongMsg").textContent=msg;
    $("wrong").style.display="block";
    $("correctAnswer").style.display="none";
    $("practiceMsg").style.display="none";
    $("selectMsg").style.display="none";
    $("almostMsg").style.display="none";
    $("backToSelectBtn").style.display="none";
}

function retry() {
    $("wrong").style.display="none";
    $("almostMsg").style.display="none";
    clearInputs();
    if(state.prob?.type==='comparison'){
        state.selectedComparison=null;
        document.querySelectorAll('.comparison-btn').forEach(btn=>btn.classList.remove('selected'));
    }
    setFocus();
}

function next() {
    nextQ();
}

// „Ç≤„Éº„É†ÁµÇ‰∫ÜÂá¶ÁêÜ
function showGameOver() {
    stopTimer();
    $("game").style.display="none";
    $("gameover").style.display="block";
    $("finalLv").textContent=state.mode==='hidden'?"Èö†„Åó":state.level;
    $("finalScore1").textContent=state.score;
    if(state.mode==='summary'||state.mode==='hidden'){
        const elapsedTime=getElapsedTime();
        $("finalTime").style.display="block";
        $("finalTimeValue").textContent=formatTime(elapsedTime);
    }
}

function showClear() {
    stopTimer();
    createFireworks();
    $("game").style.display="none";
    $("clear").style.display="block";
    $("finalScore2").textContent=state.score;
    if(state.mode==='summary'){
        hiddenStageUnlocked=true;
        try{localStorage.setItem('hiddenStageUnlocked','true')}catch(e){}
        $("hiddenStageBtn").style.display="inline-block";
        $("hiddenModeInfo").style.display="block";
        $("hiddenStageUnlock").style.display="block";
        const elapsedTime=getElapsedTime();
        $("clearTimeValue").textContent=formatTime(elapsedTime);
        displayRanking(elapsedTime);
    }
}

function showHiddenClear() {
    stopTimer();
    createMasterFireworks();
    unlockTitle('fractionMaster');
    $("game").style.display="none";
    $("hiddenClear").style.display="block";
    $("hiddenFinalScore").textContent=state.score;
}

// „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà
document.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&e.target.tagName==='INPUT'){
        e.preventDefault();
        if(e.target.id==='n'||e.target.id==='d')submitFraction();
        else if(['mw','mn','md'].includes(e.target.id))submitMixed();
        else if(e.target.id==='norm')submitNormal();
    }
    if(state.prob?.type==='comparison'){
        if(e.key==='1'){
            const btn=document.querySelector('.comparison-btn[onclick*="left"]');
            if(btn)selectComparison(btn,'left');
        }else if(e.key==='2'){
            const btn=document.querySelector('.comparison-btn[onclick*="right"]');
            if(btn)selectComparison(btn,'right');
        }else if(e.key==='3'){
            const btn=document.querySelector('.comparison-btn[onclick*="equal"]');
            if(btn)selectComparison(btn,'equal');
        }else if(e.key==='Enter'&&state.selectedComparison){
            submitComparison();
        }
    }
});
</script>
</body>
</html>
