function generateProblem(lv){
    if(state.mode==='hidden')return generateHiddenProblem();
    switch(lv){
        case 1:{
            // åˆ†æ•°Ã·åˆ†æ•°
            const[n1,d1]=randFrac(8,12);
            const[n2,d2]=randFrac(8,12);
            return{q:`${frac(n1,d1)} Ã· ${frac(n2,d2)} =`,n:n1*d2,d:d1*n2,type:'fraction',mixed:false};
        }
        case 2:{
            // åˆ†æ•°Ã·åˆ†æ•°Ã—åˆ†æ•° ã¾ãŸã¯ åˆ†æ•°Ã—åˆ†æ•°Ã·åˆ†æ•°
            const[n1,d1]=randFrac(6,10);
            const[n2,d2]=randFrac(6,10);
            const[n3,d3]=randFrac(6,10);
            if(R(1,2)===1){
                return{q:`${frac(n1,d1)} Ã· ${frac(n2,d2)} Ã— ${frac(n3,d3)} =`,n:n1*d2*n3,d:d1*n2*d3,type:'fraction',mixed:false};
            }else{
                return{q:`${frac(n1,d1)} Ã— ${frac(n2,d2)} Ã· ${frac(n3,d3)} =`,n:n1*n2*d3,d:d1*d2*n3,type:'fraction',mixed:false};
            }
        }
        case 3:{
            // æ•´æ•°Ã·åˆ†æ•°ã€å¸¯åˆ†æ•°Ã·åˆ†æ•°ãªã©
            const type=R(1,4);
            switch(type){
                case 1:{
                    // æ•´æ•°Ã·åˆ†æ•°
                    const i=R(2,8);
                    const[n,d]=randFrac(6,10);
                    return{q:`${i} Ã· ${frac(n,d)} =`,n:i*d,d:n,type:'fraction',mixed:true};
                }
                case 2:{
                    // å¸¯åˆ†æ•°Ã·çœŸåˆ†æ•°
                    const w=R(1,3),d1=R(3,6),n1=R(1,d1-1);
                    const[n2,d2]=randFrac(6,8);
                    const i1=w*d1+n1;
                    return{q:`${mixedFrac(w,n1,d1)} Ã· ${frac(n2,d2)} =`,n:i1*d2,d:d1*n2,type:'fraction',mixed:true};
                }
                case 3:{
                    // çœŸåˆ†æ•°Ã·å¸¯åˆ†æ•°
                    const[n1,d1]=randFrac(6,8);
                    const w=R(1,2),d2=R(3,5),n2=R(1,d2-1);
                    const i2=w*d2+n2;
                    return{q:`${frac(n1,d1)} Ã· ${mixedFrac(w,n2,d2)} =`,n:n1*d2,d:d1*i2,type:'fraction',mixed:false};
                }
                case 4:{
                    // å¸¯åˆ†æ•°Ã·å¸¯åˆ†æ•°
                    const w1=R(1,2),d1=R(3,5),n1=R(1,d1-1);
                    const w2=R(1,2),d2=R(3,5),n2=R(1,d2-1);
                    const i1=w1*d1+n1,i2=w2*d2+n2;
                    return{q:`${mixedFrac(w1,n1,d1)} Ã· ${mixedFrac(w2,n2,d2)} =`,n:i1*d2,d:d1*i2,type:'fraction',mixed:true};
                }
            }
        }
        case 4:{
            // å¤§å°æ¯”è¼ƒï¼ˆä¿®æ­£ç‰ˆï¼šç­”ãˆãŒãƒ©ãƒ³ãƒ€ãƒ ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
            const type=R(1,3);
            switch(type){
                case 1:{
                    // æ•´æ•°Ã·åˆ†æ•°ã¨æ•´æ•°ã®æ¯”è¼ƒ
                    const i=R(3,6);
                    const[n,d]=randFrac(6,10);
                    const leftValue=i*d/n;
                    const rightValue=i;
                    const questionType=R(1,2)===1?"å¤§ãã„":"å°ã•ã„";
                    return{q:`${i} Ã· ${frac(n,d)} ã¨ ${i} ã‚’æ¯”ã¹ã¦ã€ã©ã¡ã‚‰ãŒ${questionType}ã‹ç­”ãˆã¦ãã ã•ã„`,left:leftValue,right:rightValue,type:'comparison',questionType:questionType};
                }
                case 2:{
                    // åˆ†æ•°Ã·åˆ†æ•°ã¨åˆ†æ•°ã®æ¯”è¼ƒ
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    const leftValue=(n1*d2)/(d1*n2);
                    const rightValue=n1/d1;
                    const questionType=R(1,2)===1?"å¤§ãã„":"å°ã•ã„";
                    return{q:`${frac(n1,d1)} Ã· ${frac(n2,d2)} ã¨ ${frac(n1,d1)} ã‚’æ¯”ã¹ã¦ã€ã©ã¡ã‚‰ãŒ${questionType}ã‹ç­”ãˆã¦ãã ã•ã„`,left:leftValue,right:rightValue,type:'comparison',questionType:questionType};
                }
                case 3:{
                    // æ•´æ•°Ã·åˆ†æ•°ã¨æ•´æ•°ã®æ¯”è¼ƒï¼ˆåˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                    const i=R(4,8);
                    const[n,d]=randFrac(8,12);
                    const leftValue=i*d/n;
                    const rightValue=i;
                    const questionType=R(1,2)===1?"å¤§ãã„":"å°ã•ã„";
                    return{q:`${i} Ã· ${frac(n,d)} ã¨ ${i} ã‚’æ¯”ã¹ã¦ã€ã©ã¡ã‚‰ãŒ${questionType}ã‹ç­”ãˆã¦ãã ã•ã„`,left:leftValue,right:rightValue,type:'comparison',questionType:questionType};
                }
            }
        }
        case 5:{
            // å¼ã‚’ä½œã‚‹å•é¡Œï¼ˆä¿®æ­£ç‰ˆï¼šæ­£ã—ã„ç­”ãˆã®è¨­å®šï¼‰
            const type=R(1,2);
            switch(type){
                case 1:{
                    // ãƒ›ãƒ¼ã‚¹å•é¡Œï¼ˆä¿®æ­£ç‰ˆï¼šæ­£ã—ã„ç­”ãˆã®è¨­å®šï¼‰
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    const unit1=R(1,2)===1?"m":"L";
                    const unit2="kg";
                    const question=R(1,2)===1?"ï¼‘"+unit1+"ã®é‡ã•ã‚’æ±‚ã‚ã¾ã—ã‚‡ã†":"ï¼‘"+unit2+"ã®é•·ã•ã‚’æ±‚ã‚ã¾ã—ã‚‡ã†";
                    if(question.includes("é‡ã•ã‚’æ±‚ã‚ã¾ã—ã‚‡ã†")){
                        // n1/d1 unit1ã®é‡ã•ãŒn2/d2 kg â†’ 1unit1ã®é‡ã• = n2/d2 Ã· n1/d1
                        return{q:`${frac(n1,d1)}${unit1}ã®é‡ã•ãŒ${frac(n2,d2)}${unit2}ã®ãƒ›ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚${question}`,correctFormula:{n1:n2,d1:d2,op:"Ã·",n2:n1,d2:d1},type:'formula'};
                    }else{
                        // n1/d1 unit1ã®é‡ã•ãŒn2/d2 kg â†’ 1kgã®é•·ã• = n1/d1 Ã· n2/d2
                        return{q:`${frac(n1,d1)}${unit1}ã®é‡ã•ãŒ${frac(n2,d2)}${unit2}ã®ãƒ›ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚${question}`,correctFormula:{n1:n1,d1:d1,op:"Ã·",n2:n2,d2:d2},type:'formula'};
                    }
                }
                case 2:{
                    // ç±³ã®é‡ã•å•é¡Œï¼ˆä¿®æ­£ç‰ˆï¼šæ­£ã—ã„ç­”ãˆã®è¨­å®šï¼‰
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    const question=R(1,2)===1?"ï¼‘ï¼¬ã®é‡ã•ã‚’æ±‚ã‚ã¾ã—ã‚‡ã†":"ï¼‘ï½‹ï½‡ã®ã‹ã•ã‚’æ±‚ã‚ã¾ã—ã‚‡ã†";
                    if(question==="ï¼‘ï¼¬ã®é‡ã•ã‚’æ±‚ã‚ã¾ã—ã‚‡ã†"){
                        // ç±³n1/d1Lã®é‡ã•ãŒn2/d2kg â†’ 1Lã®é‡ã• = n2/d2 Ã· n1/d1
                        return{q:`ç±³${frac(n1,d1)}Lã®é‡ã•ã‚’é‡ã£ãŸã‚‰${frac(n2,d2)}ï½‹ï½‡ã§ã—ãŸã€‚${question}`,correctFormula:{n1:n2,d1:d2,op:"Ã·",n2:n1,d2:d1},type:'formula'};
                    }else{
                        // ç±³n1/d1Lã®é‡ã•ãŒn2/d2kg â†’ 1kgã®ã‹ã• = n1/d1 Ã· n2/d2
                        return{q:`ç±³${frac(n1,d1)}Lã®é‡ã•ã‚’é‡ã£ãŸã‚‰${frac(n2,d2)}ï½‹ï½‡ã§ã—ãŸã€‚${question}`,correctFormula:{n1:n1,d1:d1,op:"Ã·",n2:n2,d2:d2},type:'formula'};
                    }
                }
            }
        }
        case 6:{
            // å°æ•°Ã·åˆ†æ•°Ã—æ•´æ•°ã®ã‚ˆã†ãªæ··åˆè¨ˆç®—
            const type=R(1,3);
            switch(type){
                case 1:{
                    // å°æ•°Ã·åˆ†æ•°Ã—æ•´æ•°
                    const decimal=(R(10,50)/10);
                    const[n,d]=randFrac(6,10);
                    const integer=R(2,6);
                    return{q:`${decimal} Ã· ${frac(n,d)} Ã— ${integer} =`,n:decimal*d*integer*10,d:n*10,type:'fraction',mixed:false};
                }
                case 2:{
                    // æ•´æ•°Ã—åˆ†æ•°Ã·å°æ•°
                    const integer=R(3,8);
                    const[n,d]=randFrac(6,10);
                    const decimal=(R(10,30)/10);
                    return{q:`${integer} Ã— ${frac(n,d)} Ã· ${decimal} =`,n:integer*n*10,d:d*decimal*10,type:'fraction',mixed:false};
                }
                case 3:{
                    // åˆ†æ•°Ã—å°æ•°Ã·æ•´æ•°
                    const[n,d]=randFrac(6,10);
                    const decimal=(R(10,40)/10);
                    const integer=R(2,5);
                    return{q:`${frac(n,d)} Ã— ${decimal} Ã· ${integer} =`,n:n*decimal*10,d:d*integer*10,type:'fraction',mixed:false};
                }
            }
        }
        case 7:{
            // åˆ†æ•°ã§è¡¨ã—ã¾ã—ã‚‡ã†
            const type=R(1,4);
            switch(type){
                case 1:{
                    // 7ç§’ã¯ä½•åˆ†ã§ã™ã‹ï¼Ÿ
                    const seconds=R(5,50);
                    return{q:`${seconds}ç§’ã¯ä½•åˆ†ã§ã™ã‹ï¼Ÿ`,n:seconds,d:60,u:"åˆ†",type:'fraction',mixed:false};
                }
                case 2:{
                    // 6åˆ†ã¯ä½•æ™‚é–“ã§ã™ã‹ï¼Ÿ
                    const minutes=R(5,50);
                    return{q:`${minutes}åˆ†ã¯ä½•æ™‚é–“ã§ã™ã‹ï¼Ÿ`,n:minutes,d:60,u:"æ™‚é–“",type:'fraction',mixed:false};
                }
                case 3:{
                    // 3æ™‚é–“ã¯ä½•æ—¥ã§ã™ã‹ï¼Ÿ
                    const hours=R(2,20);
                    return{q:`${hours}æ™‚é–“ã¯ä½•æ—¥ã§ã™ã‹ï¼Ÿ`,n:hours,d:24,u:"æ—¥",type:'fraction',mixed:false};
                }
                case 4:{
                    // 2æ™‚é–“20åˆ†ã¯ä½•æ™‚é–“ã§ã™ã‹ï¼Ÿ
                    const hours=R(1,3);
                    const minutes=R(10,50);
                    const totalMinutes=hours*60+minutes;
                    return{q:`${hours}æ™‚é–“${minutes}åˆ†ã¯ä½•æ™‚é–“ã§ã™ã‹ï¼Ÿ`,n:totalMinutes,d:60,u:"æ™‚é–“",type:'fraction',mixed:true};
                }
            }
        }
        case 8:{
            // åˆ†æ•°ã‚’ä½¿ã£ãŸæ–‡ç« é¡Œï¼ˆä¿®æ­£ç‰ˆï¼šç´„åˆ†ã—ã‚„ã™ã„æ•°å­—ã‚’ä½¿ç”¨ã—ã€æ™‚è¨ˆå•é¡Œã‚’è¿½åŠ ï¼‰
            const type=R(1,3);
            switch(type){
                case 1:{
                    // ãƒãƒ©ã‚½ãƒ³å•é¡Œï¼ˆç´„åˆ†ã—ã‚„ã™ã„æ•°å­—ã‚’ä½¿ç”¨ï¼‰
                    const distance=[24,30,36,42,48,54,60][R(0,6)]; // ç´„åˆ†ã—ã‚„ã™ã„è·é›¢
                    const hours=R(2,4);
                    const minutes=[15,20,30,40,45][R(0,4)]; // ç´„åˆ†ã—ã‚„ã™ã„åˆ†æ•°ã«ãªã‚‹åˆ†ã‚’é¸æŠ
                    const totalMinutes=hours*60+minutes;
                    return{q:`ãƒãƒ©ã‚½ãƒ³ã§${distance}ï½‹ï½ã‚’${hours}æ™‚é–“${minutes}åˆ†ã§èµ°ã‚Šã¾ã—ãŸã€‚æ™‚é€Ÿä½•ï½‹ï½ã§ã™ã‹ï¼Ÿ`,n:distance*60,d:totalMinutes,u:"ï½‹ï½",type:'fraction',mixed:false};
                }
                case 2:{
                    // ä¸€èˆ¬çš„ãªé€Ÿåº¦å•é¡Œï¼ˆç´„åˆ†ã—ã‚„ã™ã„æ•°å­—ã‚’ä½¿ç”¨ï¼‰
                    const distance=[24,30,36,42,48,54,60][R(0,6)]; // ç´„åˆ†ã—ã‚„ã™ã„è·é›¢
                    const hours=R(1,3);
                    const minutes=[12,15,18,20,24,30,36,40,45][R(0,8)]; // ç´„åˆ†ã—ã‚„ã™ã„åˆ†æ•°ã«ãªã‚‹åˆ†
                    const totalMinutes=hours*60+minutes;
                    return{q:`${distance}ï½‹ï½ã‚’${hours}æ™‚é–“${minutes}åˆ†ã§ç§»å‹•ã—ã¾ã—ãŸã€‚æ™‚é€Ÿä½•ï½‹ï½ã§ã™ã‹ï¼Ÿ`,n:distance*60,d:totalMinutes,u:"ï½‹ï½",type:'fraction',mixed:false};
                }
                case 3:{
                    // æ™‚è¨ˆã®é€²ã¿æ–¹å•é¡Œï¼ˆæ–°è¦è¿½åŠ ï¼‰
                    const progressSeconds=[6,8,10,12,15,18,20,24][R(0,7)]; // ç´„åˆ†ã—ã‚„ã™ã„ç§’æ•°
                    const targetMinutes=[6,8,10,12,15,18,20,24][R(0,7)]; // ç´„åˆ†ã—ã‚„ã™ã„åˆ†æ•°
                    // progressSecondsç§’ã‚’åˆ†æ•°ã§è¡¨ã™ã¨ progressSeconds/60 åˆ†
                    // targetMinutesåˆ†é€²ã‚€ã®ã«å¿…è¦ãªæ—¥æ•° = targetMinutes Ã· (progressSeconds/60) = targetMinutes Ã— 60 Ã· progressSeconds
                    const answerNumerator=targetMinutes*60;
                    const answerDenominator=progressSeconds;
                    return{q:`1æ—¥ã«${progressSeconds}ç§’ãšã¤é€²ã‚€æ™‚è¨ˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ™‚è¨ˆã¯ä½•æ—¥ã§${targetMinutes}åˆ†é€²ã¿ã¾ã™ã‹ï¼Ÿ${progressSeconds}ç§’ã‚’åˆ†æ•°ã§è¡¨ã—ã¦è¨ˆç®—ã—ã¦ç­”ãˆã¾ã—ã‚‡ã†ã€‚`,n:answerNumerator,d:answerDenominator,u:"æ—¥",type:'fraction',mixed:false};
                }
            }
        }
        case 9:{
            // åˆ†æ•°ã®å€
            const type=R(1,2);
            switch(type){
                case 1:{
                    // ãƒªãƒœãƒ³ã®å€æ•°å•é¡Œ
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    return{q:`èµ¤ã„ãƒªãƒœãƒ³ã¯${frac(n1,d1)}ï½ã§ã™ã€‚é’ã„ãƒªãƒœãƒ³ã¯${frac(n2,d2)}ï½ã§ã™ã€‚é’ã„ãƒªãƒœãƒ³ã¯èµ¤ã„ãƒªãƒœãƒ³ã®ä½•å€ã§ã™ã‹ï¼Ÿ`,n:n2*d1,d:d2*n1,u:"å€",type:'fraction',mixed:false};
                }
                case 2:{
                    // ä¸€èˆ¬çš„ãªå€æ•°å•é¡Œ
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    const item=["ã²ã‚‚","ãƒ†ãƒ¼ãƒ—","æ¿"][R(0,2)];
                    return{q:`Aã®${item}ã¯${frac(n1,d1)}ï½ã§ã™ã€‚Bã®${item}ã¯${frac(n2,d2)}ï½ã§ã™ã€‚Bã®${item}ã¯Aã®${item}ã®ä½•å€ã§ã™ã‹ï¼Ÿ`,n:n2*d1,d:d2*n1,u:"å€",type:'fraction',mixed:false};
                }
            }
        }
        case 10:{
            // ã‚‚ã¨ã«ã™ã‚‹å¤§ãã•ã‚’æ±‚ã‚ã‚‹å•é¡Œ
            const type=R(1,2);
            switch(type){
                case 1:{
                    // æœ¬ã¨é›‘èªŒã®å•é¡Œ
                    const price=R(600,1200);
                    const[n,d]=randFrac(6,10);
                    return{q:`${price}å††ã®æœ¬ã‚’è²·ã„ã¾ã—ãŸã€‚ã“ã®æœ¬ã®å€¤æ®µã¯é›‘èªŒã®å€¤æ®µã®${frac(n,d)}å€ã§ã™ã€‚é›‘èªŒã®å€¤æ®µã‚’æ±‚ã‚ã¾ã—ã‚‡ã†ã€‚`,n:price*d,d:n,u:"å††",type:'fraction',mixed:false};
                }
                case 2:{
                    // ä¸€èˆ¬çš„ãªã‚‚ã¨ã®é‡å•é¡Œ
                    const amount=R(200,800);
                    const[n,d]=randFrac(6,10);
                    const item=["ãƒšãƒ³","ãƒãƒ¼ãƒˆ","æ¶ˆã—ã‚´ãƒ "][R(0,2)];
                    return{q:`${amount}å††ã®${item}ã‚’è²·ã„ã¾ã—ãŸã€‚ã“ã®${item}ã®å€¤æ®µã¯åˆ¥ã®å•†å“ã®${frac(n,d)}å€ã§ã™ã€‚åˆ¥ã®å•†å“ã®å€¤æ®µã‚’æ±‚ã‚ã¾ã—ã‚‡ã†ã€‚`,n:amount*d,d:n,u:"å††",type:'fraction',mixed:false};
                }
            }
        }
    }
}

// ä¿®æ­£ã•ã‚ŒãŸ selectLevel é–¢æ•°
function selectLevel(level){
    state.level = level; // ãƒ¬ãƒ™ãƒ«ã‚’æ­£ã—ãè¨­å®š
    state.score = 0;
    state.lvCount = 0;
    state.totalQ = 0;
    state.qNum = 0;
    state.selectQCount = 0;
    state.selectCorrectCount = 0;
    state.sessionPoints = 0;
    
    $("start").style.display = "none";
    $("levelSelect").style.display = "none";
    $("game").style.display = "block";
    
    state.mode = 'select';
    $("levelSelectBtn").style.display = "inline-block";
    $("selectQ").style.display = "inline-block";
    $("totalQ").style.display = "none";
    $("hiddenQ").style.display = "none";
    $("modeDisplay").innerHTML = `<div class="mode-info select"><strong>ğŸ® é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</strong> - ãƒ¬ãƒ™ãƒ«${state.level}</div>`;
    $("progressBar").className = "progress-bar select";
    
    updateLevelIndicator();
    updateProgressBar();
    newProblem();
}

function selectMode(mode){
    state.mode=mode;
    state.score=0;
    state.level=1; // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç­‰ã§ã¯1ã‹ã‚‰é–‹å§‹
    state.lvCount=0;
    state.totalQ=0;
    state.qNum=0;
    state.selectQCount=0;
    state.hiddenQ=0;
    state.selectCorrectCount=0;
    state.sessionPoints=0;
    
    $("start").style.display="none";
    $("levelSelect").style.display="none";
    $("game").style.display="block";
    
    if(mode==='select'){
        // é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ¬ãƒ™ãƒ«é¸æŠç”»é¢ã«æˆ»ã‚‹
        $("game").style.display="none";
        showLevelSelect();
        return;
    }else if(mode==='practice'){
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
        $("modeDisplay").innerHTML='<div class="mode-info practice"><strong>ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("progressBar").className="progress-bar practice";
    }else if(mode==='summary'){
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("totalQ").style.display="inline-block";
        $("hiddenQ").style.display="none";
        $("modeDisplay").innerHTML='<div class="mode-info summary"><strong>ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("progressBar").className="progress-bar summary";
        startTimer();
    }else if(mode==='hidden'){
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="inline-block";
        $("modeDisplay").innerHTML='<div class="mode-info hidden"><strong>ğŸ‘‘ éš ã—ã‚¹ãƒ†ãƒ¼ã‚¸</strong></div>';
        $("progressBar").className="progress-bar hidden";
        startTimer();
    }
    
    updateLevelIndicator();
    updateProgressBar();
    newProblem();
}

function showLevelSelect(){
    $("start").style.display="none";
    $("levelSelect").style.display="block";
    updateLevelSelectDisplay();
}

function backToStart(){
    $("game").style.display="none";
    $("gameover").style.display="none";
    $("clear").style.display="none";
    $("levelClear").style.display="none";
    $("hiddenClear").style.display="none";
    $("levelSelect").style.display="none";
    $("start").style.display="block";
    stopTimer();
    
    if(state.sessionPoints>0){
        $("sessionPoints").style.display="block";
    }
}

function backToLevelSelect(){
    $("game").style.display="none";
    $("levelClear").style.display="none";
    showLevelSelect();
}

function updateLevelIndicator(){
    const indicator=$("levelIndicator");
    indicator.innerHTML="";
    
    if(state.mode==='practice'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(state.completed.has(i))dot.classList.add("completed");
            if(i===state.level)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='summary'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<state.level||(i===state.level&&state.totalQ%5===0&&state.totalQ>0))dot.classList.add("completed");
            if(i===state.level)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='hidden'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<=state.hiddenQ)dot.classList.add("completed");
            if(i===state.hiddenQ+1)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='select'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<=state.selectCorrectCount)dot.classList.add("completed");
            if(i===state.selectCorrectCount+1)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }
}

function updateProgressBar(){
    const progressBar=$("progressBar");
    let progress=0;
    
    if(state.mode==='practice'){
        progress=(state.lvCount/5)*100;
        $("levelProgress").textContent=`ã“ã®ãƒ¬ãƒ™ãƒ«: ${state.lvCount}/5å•æ­£è§£`;
    }else if(state.mode==='summary'){
        progress=(state.totalQ/50)*100;
        $("levelProgress").textContent="";
    }else if(state.mode==='hidden'){
        progress=(state.hiddenQ/10)*100;
        $("levelProgress").textContent="";
    }else if(state.mode==='select'){
        progress=(state.selectCorrectCount/10)*100;
        $("levelProgress").textContent=`é€£ç¶šæ­£è§£: ${state.selectCorrectCount}/10å•`;
    }
    
    progressBar.style.width=progress+"%";
}

function newProblem(){
    state.prob=generateProblem(state.level);
    state.unit=state.prob.u||"";
    $("q").innerHTML=state.prob.q;
    $("monster").textContent=monsters[state.level-1];
    $("lv").textContent=state.level;
    $("lvInfo").textContent=lvNames[state.level-1];
    
    // å˜ä½è¡¨ç¤ºã®æ›´æ–°
    if(state.unit){
        $("fUnit").textContent=state.unit;
        $("mUnit").textContent=state.unit;
        $("nUnit").textContent=state.unit;
        $("fUnit").style.display="block";
        $("mUnit").style.display="block";
        $("nUnit").style.display="block";
    }else{
        $("fUnit").style.display="none";
        $("mUnit").style.display="none";
        $("nUnit").style.display="none";
    }
    
    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¯ãƒªã‚¢
    $("n").value="";
    $("d").value="";
    $("mw").value="";
    $("mn").value="";
    $("md").value="";
    $("norm").value="";
    $("f1n").value="";
    $("f1d").value="";
    $("operator").value="";
    $("f2n").value="";
    $("f2d").value="";
    
    // è¡¨ç¤ºã®åˆ¶å¾¡
    if(state.prob.type==='comparison'){
        $("answerSections").style.display="none";
        $("formulaSection").style.display="none";
        $("comparisonInput").style.display="block";
        state.selectedComparison=null;
        document.querySelectorAll('.comparison-btn').forEach(btn=>btn.classList.remove('selected'));
    }else if(state.prob.type==='formula'){
        $("answerSections").style.display="none";
        $("comparisonInput").style.display="none";
        $("formulaSection").style.display="flex";
        updateFormulaPreview();
    }else{
        $("answerSections").style.display="flex";
        $("formulaSection").style.display="none";
        $("comparisonInput").style.display="none";
        $("mixedSection").style.display=state.prob.mixed?"block":"none";
    }
    
    $("wrong").style.display="none";
    
    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’é©åˆ‡ãªå…¥åŠ›æ¬„ã«è¨­å®š
    setTimeout(() => {
        if(state.prob.type==='formula'){
            $("f1n").focus();
        }else if(state.prob.type!=='comparison'){
            $("d").focus();
        }
    }, 100);
}

// æ®‹ã‚Šã®é–¢æ•°ã¯å‰å›å‡ºåŠ›ã—ãŸã‚³ãƒ¼ãƒ‰ã¨åŒã˜ã§ã™...
function submitFormula(){
    const f1n=parseInt($("f1n").value);
    const f1d=parseInt($("f1d").value);
    const operator=$("operator").value;
    const f2n=parseInt($("f2n").value);
    const f2d=parseInt($("f2d").value);
    
    if(isNaN(f1n)||isNaN(f1d)||!operator||isNaN(f2n)||isNaN(f2d)){
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const correct=state.prob.correctFormula;
    if(f1n===correct.n1&&f1d===correct.d1&&operator===correct.op&&f2n===correct.n2&&f2d===correct.d2){
        handleCorrect();
    }else{
        handleWrong(`${correct.n1}/${correct.d1} ${correct.op} ${correct.n2}/${correct.d2}`);
    }
}

function selectComparison(btn,choice){
    document.querySelectorAll('.comparison-btn').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    state.selectedComparison=choice;
}

function submitComparison(){
    if(!state.selectedComparison){
        alert('é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„');
        return;
    }
    
    let correct=false;
    const questionType=state.prob.questionType||"å¤§ãã„";
    
    if(questionType==="å¤§ãã„"){
        if(state.selectedComparison==='left'&&state.prob.left>state.prob.right)correct=true;
        if(state.selectedComparison==='right'&&state.prob.left<state.prob.right)correct=true;
        if(state.selectedComparison==='equal'&&state.prob.left===state.prob.right)correct=true;
    }else{
        if(state.selectedComparison==='left'&&state.prob.left<state.prob.right)correct=true;
        if(state.selectedComparison==='right'&&state.prob.left>state.prob.right)correct=true;
        if(state.selectedComparison==='equal'&&state.prob.left===state.prob.right)correct=true;
    }
    
    if(correct){
        handleCorrect();
    }else{
        let correctAnswer;
        if(questionType==="å¤§ãã„"){
            correctAnswer=state.prob.left>state.prob.right?'å·¦ãŒã‚':
                         state.prob.left<state.prob.right?'å³ãŒã‚':'åŒã˜';
        }else{
            correctAnswer=state.prob.left<state.prob.right?'å·¦ãŒã‚':
                         state.prob.left>state.prob.right?'å³ãŒã‚':'åŒã˜';
        }
        handleWrong(correctAnswer);
    }
}

function submitFraction(){
    const n=parseInt($("n").value);
    const d=parseInt($("d").value);
    if(isNaN(n)||isNaN(d)||d<=0){
        alert('æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    checkFractionAnswer(n,d);
}

function submitMixed(){
    const w=parseInt($("mw").value)||0;
    const n=parseInt($("mn").value)||0;
    const d=parseInt($("md").value);
    if(isNaN(d)||d<=0){
        alert('æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    const improperN=w*d+n;
    checkFractionAnswer(improperN,d);
}

function submitNormal(){
    const input=$("norm").value.trim();
    if(!input){
        alert('ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    let userAnswer;
    if(input.includes('/')){
        const parts=input.split('/');
        if(parts.length!==2){
            alert('åˆ†æ•°ã¯ã€Œåˆ†å­/åˆ†æ¯ã€ã®å½¢ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        const n=parseInt(parts[0]);
        const d=parseInt(parts[1]);
        if(isNaN(n)||isNaN(d)||d<=0){
            alert('æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        checkFractionAnswer(n,d);
        return;
    }else{
        userAnswer=parseFloat(input);
        if(isNaN(userAnswer)){
            alert('æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
    }
    
    const[correctN,correctD]=simplify(state.prob.n,state.prob.d);
    const correctDecimal=correctN/correctD;
    
    if(Math.abs(userAnswer-correctDecimal)<0.001){
        handleCorrect();
    }else{
        handleWrong(formatAnswer(state.prob.n,state.prob.d,state.unit));
    }
}

function checkFractionAnswer(userN,userD){
    const[correctN,correctD]=simplify(state.prob.n,state.prob.d);
    
    // ç´„åˆ†ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const userGcd = gcd(Math.abs(userN), Math.abs(userD));
    
    if(userGcd > 1){
        // ç´„åˆ†ã•ã‚Œã¦ã„ãªã„å ´åˆã¯é–“é•ã„ã¨ã—ã¦æ‰±ã†
        const[simplifiedN,simplifiedD]=simplify(userN,userD);
        $("almostMsg").style.display="block";
        $("almostText").textContent=`${userN}/${userD} ã¯ç´„åˆ†ã™ã‚‹ã¨ ${simplifiedN}/${simplifiedD} ã«ãªã‚Šã¾ã™`;
        $("correctAnswer").style.display="block";
        $("correctText").textContent=formatAnswer(state.prob.n,state.prob.d,state.unit);
        $("wrong").style.display="block";
        return;
    }
    
    // ç´„åˆ†ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æ­£è§£åˆ¤å®š
    if(userN===correctN&&userD===correctD){
        handleCorrect();
    }else{
        handleWrong(formatAnswer(state.prob.n,state.prob.d,state.unit));
    }
}

async function handleCorrect(){
    state.score++;
    $("score").textContent=state.score;
    
    const points=calculateCorrectPoints(state.level,state.mode);
    await addPoints(points);
    
    $("monster").classList.add("correct");
    setTimeout(()=>$("monster").classList.remove("correct"),1500);
    
    if(state.mode==='practice'){
        state.lvCount++;
        if(state.lvCount>=5){
            state.completed.add(state.level);
            const levelPoints=calculateLevelPoints(state.level,state.mode);
            await addPoints(levelPoints);
            
            $("monster").classList.add("level-up");
            setTimeout(()=>$("monster").classList.remove("level-up"),3000);
            
            if(state.level<10){
                state.level++;
                state.lvCount=0;
            }else{
                setTimeout(()=>{
                    alert('ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰å…¨ãƒ¬ãƒ™ãƒ«å®Œäº†ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼');
                    backToStart();
                },2000);
                return;
            }
        }
    }else if(state.mode==='summary'){
        state.totalQ++;
        if(state.totalQ>=50){
            stopTimer();
            const clearTime=getElapsedTime();
            enableHiddenStage();
            setTimeout(()=>showClear(clearTime),1000);
            return;
        }else if(state.totalQ%5===0){
            state.level++;
        }
    }else if(state.mode==='hidden'){
        state.hiddenQ++;
        if(state.hiddenQ>=10){
            stopTimer();
            setTimeout(()=>showHiddenClear(),1000);
            return;
        }
    }else if(state.mode==='select'){
        state.selectQCount++;
        state.selectCorrectCount++;
        
        // 10å•é€£ç¶šæ­£è§£ã§ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢
        if(state.selectCorrectCount>=10){
            state.clearedLevels.add(state.level);
            saveClearedLevels();
            
            const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
            await addPoints(levelClearPoints);
            
            setTimeout(()=>showLevelClear(),1000);
            return;
        }
    }
    
    updateLevelIndicator();
    updateProgressBar();
    setTimeout(newProblem,1500);
}

function handleWrong(correctAnswer){
    $("almostMsg").style.display="none";
    $("correctAnswer").style.display="block";
    $("correctText").textContent=correctAnswer;
    
    if(state.mode==='practice'){
        $("practiceMsg").style.display="block";
        $("selectMsg").style.display="none";
        $("backToSelectBtn").style.display="none";
        state.lvCount=0;
    }else if(state.mode==='summary'||state.mode==='hidden'){
        stopTimer();
        const finalTime=getElapsedTime();
        setTimeout(()=>showGameOver(finalTime),2000);
        return;
    }else{
        $("practiceMsg").style.display="none";
        $("selectMsg").style.display="block";
        $("backToSelectBtn").style.display="inline-block";
        state.selectCorrectCount=0;
    }
    
    $("monster").classList.add("wrong");
    setTimeout(()=>$("monster").classList.remove("wrong"),1000);
    $("wrong").style.display="block";
    updateProgressBar();
}

function retry(){
    $("wrong").style.display="none";
    newProblem();
}

function next(){
    $("wrong").style.display="none";
    newProblem();
}

async function showGameOver(finalTime){
    $("game").style.display="none";
    $("gameover").style.display="block";
    $("finalLv").textContent=state.level;
    $("finalScore1").textContent=state.score;
    
    if(state.mode==='summary'||state.mode==='hidden'){
        $("finalTime").style.display="block";
        $("finalTimeValue").textContent=formatTime(finalTime);
        
        if(state.score > 0){
            const gameoverPoints=state.level*20;
            $("gameoverPoints").style.display="block";
            $("gameoverPointsValue").textContent=gameoverPoints;
            await addPoints(gameoverPoints);
        }
        
        displayGlobalRanking('#globalRankingGameover','#myGlobalRankGameover');
    }
}

async function showClear(clearTime){
    $("game").style.display="none";
    $("clear").style.display="block";
    $("finalScore2").textContent=state.score;
    $("clearTimeValue").textContent=formatTime(clearTime);
    
    const clearPoints=calculateClearPoints(clearTime);
    $("pointsEarned").style.display="block";
    $("earnedPoints").textContent=clearPoints;
    await addPoints(clearPoints);
    
    try{localStorage.setItem('summaryCleared','true')}catch(e){}
    
    createFireworks();
    displayGlobalRanking('#globalRankingClear','#myGlobalRankClear');
    
    $("hiddenStageUnlock").style.display="block";
}

async function showLevelClear(){
    $("game").style.display="none";
    $("levelClear").style.display="block";
    $("clearedLevel").textContent=state.level;
    
    const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
    $("levelClearPointsValue").textContent=levelClearPoints;
    
    createFireworks();
}

async function showHiddenClear(){
    $("game").style.display="none";
    $("hiddenClear").style.display="block";
    $("hiddenFinalScore").textContent=state.score;
    
    createMasterFireworks();
    unlockTitle('divisionMaster');
    
    const hiddenPoints=3000;
    $("hiddenPointsEarned").style.display="block";
    $("hiddenEarnedPoints").textContent=hiddenPoints;
    await addPoints(hiddenPoints);
    
    displayGlobalRanking('#globalRankingHidden','#myGlobalRankHidden');
}

function restart(){
    state.sessionPoints=0;
    backToStart();
}

function createFireworks(){
    const celebration=$("celebration");
    celebration.innerHTML="";
    
    for(let i=0;i<20;i++){
        const firework=document.createElement("div");
        firework.className="firework";
        firework.style.left=Math.random()*100+"%";
        firework.style.top=Math.random()*100+"%";
        firework.style.animationDelay=Math.random()*2+"s";
        celebration.appendChild(firework);
        
        setTimeout(()=>firework.remove(),3000);
    }
    
    for(let i=0;i<50;i++){
        const sparkle=document.createElement("div");
        sparkle.className="sparkle";
        sparkle.style.left=Math.random()*100+"%";
        sparkle.style.top=Math.random()*100+"%";
        sparkle.style.animationDelay=Math.random()*3+"s";
        celebration.appendChild(sparkle);
        
        setTimeout(()=>sparkle.remove(),4000);
    }
}

function createMasterFireworks(){
    const celebration=$("celebration");
    celebration.innerHTML="";
    
    for(let i=0;i<50;i++){
        const firework=document.createElement("div");
        firework.className="firework";
        firework.style.left=Math.random()*100+"%";
        firework.style.top=Math.random()*100+"%";
        firework.style.animationDelay=Math.random()*3+"s";
        firework.style.background=`hsl(${Math.random()*360},100%,50%)`;
        celebration.appendChild(firework);
        
        setTimeout(()=>firework.remove(),5000);
    }
    
    for(let i=0;i<100;i++){
        const sparkle=document.createElement("div");
        sparkle.className="sparkle";
        sparkle.style.left=Math.random()*100+"%";
        sparkle.style.top=Math.random()*100+"%";
        sparkle.style.animationDelay=Math.random()*5+"s";
        sparkle.style.background=`hsl(${Math.random()*360},100%,70%)`;
        celebration.appendChild(sparkle);
        
        setTimeout(()=>sparkle.remove(),6000);
    }
}

function unlockTitle(titleKey){
    if(titles[titleKey]){
        titles[titleKey].unlocked=true;
        try{localStorage.setItem('titles',JSON.stringify(titles))}catch(e){}
    }
}

try{
    if(localStorage.getItem('summaryCleared')==='true'){
        enableHiddenStage();
    }
}catch(e){}

document.addEventListener('keydown',function(e){
    if(e.key==='Enter'&&$("game").style.display==="block"){
        if($("comparisonInput").style.display==="block"){
            submitComparison();
        }else if($("formulaSection").style.display==="flex"){
            submitFormula();
        }else if($("n").value&&$("d").value){
            submitFraction();
        }else if($("norm").value){
            submitNormal();
        }
    }
});
</script>
</body>
</html>
