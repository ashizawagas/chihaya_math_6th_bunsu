function unlockTitle(titleKey){
    if(titles[titleKey]){
        titles[titleKey].unlocked=true;
        try{localStorage.setItem('titles',JSON.stringify(titles))}catch(e){}
    }
}

// 修正された selectLevel 関数
function selectLevel(level){
    state.level = level; // レベルを正しく設定
    state.score = 0;
    state.lvCount = 0;
    state.totalQ = 0;
    state.qNum = 0;
    state.selectQCount = 0;
    state.selectCorrectCount = 0;
    state.sessionPoints = 0;
    
    $("start").style.display = "none";
    $("levelSelect").style.display = "none";
    $("game").style.display = "block";
    
    state.mode = 'select';
    $("levelSelectBtn").style.display = "inline-block";
    $("selectQ").style.display = "inline-block";
    $("totalQ").style.display = "none";
    $("hiddenQ").style.display = "none";
    $("modeDisplay").innerHTML = `<div class="mode-info select"><strong>🎮 選べるモード</strong> - レベル${state.level}</div>`;
    $("progressBar").className = "progress-bar select";
    
    updateLevelIndicator();
    updateProgressBar();
    newProblem();
}

function selectMode(mode){
    state.mode=mode;
    state.score=0;
    state.level=1; // 練習モード等では1から開始
    state.lvCount=0;
    state.totalQ=0;
    state.qNum=0;
    state.selectQCount=0;
    state.hiddenQ=0;
    state.selectCorrectCount=0;
    state.sessionPoints=0;
    
    $("start").style.display="none";
    $("levelSelect").style.display="none";
    $("game").style.display="block";
    
    if(mode==='select'){
        // 選べるモードの場合はレベル選択画面に戻る
        $("game").style.display="none";
        showLevelSelect();
        return;
    }else if(mode==='practice'){
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
        $("modeDisplay").innerHTML='<div class="mode-info practice"><strong>📚 練習モード</strong></div>';
        $("progressBar").className="progress-bar practice";
    }else if(mode==='summary'){
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("totalQ").style.display="inline-block";
        $("hiddenQ").style.display="none";
        $("modeDisplay").innerHTML='<div class="mode-info summary"><strong>🎯 まとめモード</strong></div>';
        $("progressBar").className="progress-bar summary";
        startTimer();
    }else if(mode==='hidden'){
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="inline-block";
        $("modeDisplay").innerHTML='<div class="mode-info hidden"><strong>👑 隠しステージ</strong></div>';
        $("progressBar").className="progress-bar hidden";
        startTimer();
    }
    
    updateLevelIndicator();
    updateProgressBar();
    newProblem();
}

function showLevelSelect(){
    $("start").style.display="none";
    $("levelSelect").style.display="block";
    updateLevelSelectDisplay();
}

function backToStart(){
    $("game").style.display="none";
    $("gameover").style.display="none";
    $("clear").style.display="none";
    $("levelClear").style.display="none";
    $("hiddenClear").style.display="none";
    $("levelSelect").style.display="none";
    $("start").style.display="block";
    stopTimer();
    
    if(state.sessionPoints>0){
        $("sessionPoints").style.display="block";
    }
}

function backToLevelSelect(){
    $("game").style.display="none";
    $("levelClear").style.display="none";
    showLevelSelect();
}

function updateLevelIndicator(){
    const indicator=$("levelIndicator");
    indicator.innerHTML="";
    
    if(state.mode==='practice'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(state.completed.has(i))dot.classList.add("completed");
            if(i===state.level)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='summary'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<state.level||(i===state.level&&state.totalQ%5===0&&state.totalQ>0))dot.classList.add("completed");
            if(i===state.level)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='hidden'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<=state.hiddenQ)dot.classList.add("completed");
            if(i===state.hiddenQ+1)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='select'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<=state.selectCorrectCount)dot.classList.add("completed");
            if(i===state.selectCorrectCount+1)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }
}

function updateProgressBar(){
    const progressBar=$("progressBar");
    let progress=0;
    
    if(state.mode==='practice'){
        progress=(state.lvCount/5)*100;
        $("levelProgress").textContent=`このレベル: ${state.lvCount}/5問正解`;
    }else if(state.mode==='summary'){
        progress=(state.totalQ/50)*100;
        $("levelProgress").textContent="";
    }else if(state.mode==='hidden'){
        progress=(state.hiddenQ/10)*100;
        $("levelProgress").textContent="";
    }else if(state.mode==='select'){
        progress=(state.selectCorrectCount/10)*100;
        $("levelProgress").textContent=`連続正解: ${state.selectCorrectCount}/10問`;
    }
    
    progressBar.style.width=progress+"%";
}

try{
    if(localStorage.getItem('summaryCleared')==='true'){
        enableHiddenStage();
    }
}catch(e){}

document.addEventListener('keydown',function(e){
    if(e.key==='Enter'&&$("game").style.display==="block"){
        if($("comparisonInput").style.display==="block"){
            submitComparison();
        }else if($("formulaSection").style.display==="flex"){
            submitFormula();
        }else if($("n").value&&$("d").value){
            submitFraction();
        }else if($("norm").value){
            submitNormal();
        }
    }
});
</script>
</body>
</html>
