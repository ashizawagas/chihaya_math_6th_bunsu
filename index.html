<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ÂçÉÊó©ÁÆóÊï∞„ÇØ„Ç®„Çπ„Éà - 6Âπ¥ÁîüÂàÜÊï∞„ÅÆÂâ≤„ÇäÁÆóÁâà</title>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, getDocs, query, orderBy, limit, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // FirebaseË®≠ÂÆö
    const firebaseConfig = {
        apiKey: "AIzaSyBxis_hmhvm9CR8xea8trCsMWltL-B343I",
        authDomain: "chihayamath6th0601.firebaseapp.com",
        projectId: "chihayamath6th0601",
        storageBucket: "chihayamath6th0601.firebasestorage.app",
        messagingSenderId: "537279903794",
        appId: "1:537279903794:web:830a1f9ab8a4078ef7642b",
        measurementId: "G-ZQJ6W66F3J"
    };

    // Firebase„ÅÆÂàùÊúüÂåñ
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶Ë®≠ÂÆö
    window.db = db;
    window.firestore = { collection, doc, setDoc, getDocs, query, orderBy, limit, serverTimestamp, getDoc };
    
    console.log('FirebaseÂàùÊúüÂåñÂÆå‰∫Ü');
</script>

<style>
body{font-family:Arial;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform .3s;margin:20px 0}
.monster.level-up{animation:levelUp 3s}
.monster.correct{animation:correct 1.5s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{0%{transform:scale(1) rotate(0deg);color:#333}20%{transform:scale(1.5) rotate(90deg);color:#ff0;filter:drop-shadow(0 0 20px #ff0)}40%{transform:scale(2) rotate(180deg);color:#f0f;filter:drop-shadow(0 0 30px #f0f)}60%{transform:scale(2.5) rotate(270deg);color:#0ff;filter:drop-shadow(0 0 40px #0ff)}80%{transform:scale(3) rotate(360deg);color:#0f0;filter:drop-shadow(0 0 50px #0f0)}100%{transform:scale(1) rotate(360deg);color:gold;filter:drop-shadow(0 0 20px gold)}}
@keyframes correct{0%{transform:scale(1);color:#333}25%{transform:scale(1.3) rotate(10deg);color:#0f0;filter:drop-shadow(0 0 15px #0f0)}50%{transform:scale(1.5) rotate(-10deg);color:#00ff00;filter:drop-shadow(0 0 25px #00ff00)}75%{transform:scale(1.3) rotate(5deg);color:#32cd32;filter:drop-shadow(0 0 20px #32cd32)}100%{transform:scale(1);color:gold;filter:drop-shadow(0 0 10px gold)}}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2)rotate(-10deg);color:#f00}50%{transform:scale(1.2)rotate(10deg);color:#f00}75%{transform:scale(1.2)rotate(-10deg);color:#f00}100%{transform:scale(1);color:#333}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
.mode-btn{background:#2196f3;padding:15px 30px;font-size:18px;margin:20px}
.mode-btn:hover{background:#1976d2}
.mode-btn.practice{background:#ff9800}
.mode-btn.practice:hover{background:#f57c00}
.mode-btn.select{background:#9c27b0}
.mode-btn.select:hover{background:#7b1fa2}
.mode-btn.hidden{background:#ff6b6b;animation:hiddenPulse 2s infinite}
.mode-btn.hidden:hover{background:#d32f2f}
@keyframes hiddenPulse{0%,100%{transform:scale(1);box-shadow:0 0 10px #ff6b6b}50%{transform:scale(1.05);box-shadow:0 0 20px #ff6b6b}}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
input:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,.3)}
select{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
select:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,.3)}
.status{margin:15px 0;font-size:18px}
.progress{background:#e0e0e0;border-radius:10px;margin:15px 0;height:20px;overflow:hidden}
.progress-bar{height:100%;transition:width .3s}
.progress-bar.practice{background:#ff9800}
.progress-bar.summary{background:#f44336}
.progress-bar.select{background:#9c27b0}
.progress-bar.hidden{background:linear-gradient(45deg,#ff6b6b,#ffd700,#4caf50,#2196f3);background-size:400% 400%;animation:hiddenProgress 3s ease infinite}
@keyframes hiddenProgress{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:10px;margin:10px 0;border-radius:8px;font-size:16px}
.mode-info.practice{background:#fff3e0;color:#f57c00;border:2px solid #ff9800}
.mode-info.summary{background:#ffebee;color:#d32f2f;border:2px solid #f44336}
.mode-info.select{background:#f3e5f5;color:#7b1fa2;border:2px solid #9c27b0}
.mode-info.hidden{background:linear-gradient(45deg,#ffebee,#fff3e0,#e8f5e8,#e3f2fd);color:#d32f2f;border:2px solid #ff6b6b;animation:hiddenGlow 2s infinite}
@keyframes hiddenGlow{0%,100%{box-shadow:0 0 10px rgba(255,107,107,0.3)}50%{box-shadow:0 0 20px rgba(255,107,107,0.6)}}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 3s infinite;padding:40px;border-radius:20px;margin:20px}
@keyframes rainbow{0%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}25%{background:linear-gradient(45deg,#a8e6cf,#dcedc1);transform:scale(1.05)}50%{background:linear-gradient(45deg,#ffd93d,#ff6b6b);transform:scale(1.1)}75%{background:linear-gradient(45deg,#74b9ff,#0984e3);transform:scale(1.05)}100%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-sections{display:flex;justify-content:center;gap:20px;margin:20px 0;flex-wrap:wrap}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:15px;min-width:180px}
.answer-section h3{margin:0 0 10px 0;color:#2196f3;font-size:16px}
.fraction-input{display:flex;flex-direction:column;align-items:center;gap:5px;margin:10px 0}
.fraction-input input{width:70px;text-align:center;margin:2px}
.fraction-line{width:80px;height:2px;background:#333;margin:3px 0}
.mixed-input{display:flex;align-items:center;justify-content:center;gap:8px;margin:10px 0}
.mixed-input input{width:50px;text-align:center}
.normal-input{display:flex;flex-direction:column;align-items:center;gap:10px}
.normal-input input{width:100px;text-align:center}
.unit-display{font-size:14px;font-weight:bold;color:#666;margin-top:5px}
.submit-btn{padding:12px 20px;font-size:16px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer}
.submit-btn:hover{background:#45a049}
.comparison-options{display:flex;justify-content:center;gap:15px;margin:20px 0}
.comparison-btn{padding:12px 25px;font-size:16px;background:#e3f2fd;border:2px solid #2196f3;border-radius:8px;cursor:pointer}
.comparison-btn:hover{background:#2196f3;color:white}
.comparison-btn.selected{background:#2196f3;color:white}
.fraction-display{display:inline-block;text-align:center;vertical-align:middle;margin:0 5px}
.fraction-display .numerator{display:block;line-height:1.2}
.fraction-display .denominator{display:block;line-height:1.2}
.fraction-display .fraction-bar{display:block;border-top:2px solid #333;margin:2px 0;min-width:25px}
.level-indicator{display:flex;justify-content:center;gap:8px;margin:15px 0;flex-wrap:wrap}
.level-dot{width:25px;height:25px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
.level-dot.completed{background:#4caf50;color:white}
.level-dot.current{background:#2196f3;color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50}
.error-msg{background:#ffebee;color:#d32f2f;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #f44336}
.almost-msg{background:#fff3e0;color:#f57c00;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #ff9800}
.level-select{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;max-width:600px;margin:20px auto}
.level-btn{padding:15px;background:#e3f2fd;border:2px solid #2196f3;border-radius:10px;cursor:pointer;text-align:center;font-size:14px;transition:all 0.3s;position:relative}
.level-btn:hover{background:#2196f3;color:white;transform:scale(1.05)}
.level-btn h4{margin:5px 0;font-size:16px}
.level-btn p{margin:5px 0;font-size:12px;opacity:0.8}
.level-btn.cleared{background:linear-gradient(45deg,#ffd700,#ffed4e);border:3px solid #ff6b6b;animation:clearedGlow 2s infinite}
.level-btn.cleared::after{content:'üèÜ‚ú®';position:absolute;top:-10px;right:-10px;font-size:20px;animation:bounce 1s infinite}
@keyframes clearedGlow{0%,100%{box-shadow:0 0 15px rgba(255,215,0,0.5)}50%{box-shadow:0 0 30px rgba(255,215,0,0.8)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.correct-celebration{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1000}
.firework{position:absolute;width:4px;height:4px;background:radial-gradient(circle,#ff0,#f00);border-radius:50%;animation:firework 2s ease-out forwards}
@keyframes firework{0%{transform:scale(1);opacity:1}100%{transform:scale(20);opacity:0}}
.sparkle{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;animation:sparkle 1.5s ease-out infinite}
@keyframes sparkle{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}
.nav-buttons{display:flex;justify-content:center;gap:10px;margin:15px 0;flex-wrap:wrap}
.nav-btn{background:#6c757d;color:white;padding:8px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer}
.nav-btn:hover{background:#5a6268}
.timer{font-size:20px;font-weight:bold;color:#d32f2f;margin:10px 0;padding:10px;background:white;border-radius:8px;border:2px solid #f44336}
.ranking{background:white;border-radius:10px;padding:20px;margin:20px 0;border:2px solid #ffd700}
.ranking h3{color:#d32f2f;margin-bottom:15px}
.ranking-item{display:flex;justify-content:space-between;align-items:center;padding:8px 15px;margin:5px 0;border-radius:5px;background:#f8f9fa}
.ranking-item.current{background:#e8f5e8;border:2px solid #4caf50;font-weight:bold}
.ranking-item.top3{background:#fff3cd;border:2px solid #ffc107}
.rank-medal{font-size:20px;margin-right:10px}
@keyframes titleGlow{0%,100%{transform:scale(1);box-shadow:0 0 20px #ffd700}50%{transform:scale(1.05);box-shadow:0 0 40px #ffd700,0 0 60px #ff6b6b}}
@keyframes masterCelebration{0%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.5) rotate(90deg);filter:hue-rotate(90deg)}50%{transform:scale(2) rotate(180deg);filter:hue-rotate(180deg)}75%{transform:scale(1.5) rotate(270deg);filter:hue-rotate(270deg)}100%{transform:scale(1) rotate(360deg);filter:hue-rotate(360deg)}}
.master-celebration{animation:masterCelebration 4s ease-in-out}
.hidden-stage-unlock{background:linear-gradient(45deg,#ff6b6b,#ffd700);color:white;font-weight:bold;animation:hiddenUnlock 3s infinite}
@keyframes hiddenUnlock{0%,100%{transform:scale(1);box-shadow:0 0 15px rgba(255,107,107,0.5)}50%{transform:scale(1.1);box-shadow:0 0 30px rgba(255,215,0,0.8)}}
.points-display{background:linear-gradient(45deg,#ffd700,#ffed4e);color:#d32f2f;padding:15px;border-radius:10px;margin:15px 0;border:3px solid #ff6b6b;font-weight:bold;font-size:18px;animation:pointsGlow 2s infinite}
@keyframes pointsGlow{0%,100%{box-shadow:0 0 15px rgba(255,215,0,0.5)}50%{box-shadow:0 0 30px rgba(255,215,0,0.8)}}
.points-earned{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50;font-weight:bold;animation:pointsEarn 2s}
@keyframes pointsEarn{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
.session-points{background:#e3f2fd;color:#1976d2;padding:8px;border-radius:6px;margin:5px 0;border:1px solid #2196f3;font-size:14px}
.player-id{background:#f3e5f5;color:#7b1fa2;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #9c27b0;font-size:14px;font-weight:bold}
.global-ranking{background:#fff3cd;border-radius:10px;padding:20px;margin:20px 0;border:2px solid #ffc107}
.global-ranking h3{color:#f57c00;margin-bottom:15px}
.global-ranking-item{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;margin:5px 0;border-radius:5px;background:#fff8e1}
.global-ranking-item.my-rank{background:#e8f5e8;border:2px solid #4caf50;font-weight:bold}
.level-clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 3s infinite;padding:40px;border-radius:20px;margin:20px}
.formula-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:15px;min-width:300px}
.formula-section h3{margin:0 0 10px 0;color:#2196f3;font-size:16px}
.formula-input{display:flex;flex-direction:column;align-items:center;gap:10px}
.formula-builder{display:flex;align-items:center;gap:10px;margin:10px 0;flex-wrap:wrap;justify-content:center}
.formula-builder input{width:60px;text-align:center}
.formula-builder select{width:80px;text-align:center}
.formula-preview{background:#f5f5f5;padding:10px;border-radius:5px;margin:10px 0;font-size:18px;min-height:30px}
</style>
</head>
<body>
<h1>üßÆ ÂçÉÊó©ÁÆóÊï∞„ÇØ„Ç®„Çπ„Éà - 6Âπ¥ÁîüÂàÜÊï∞„ÅÆÂâ≤„ÇäÁÆóÁâà</h1>

<div id="start">
<h2>„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
<div id="playerIdDisplay" class="player-id" style="display:none">üë§ „Éó„É¨„Ç§„É§„ÉºID: <span id="playerId"></span></div>
<div id="pointsDisplay" class="points-display" style="display:none">üí∞ Á∑è„Éù„Ç§„É≥„Éà: <span id="totalPoints">0</span>P</div>
<div class="info">
<div class="mode-info select"><h3>üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</h3><p>‚Ä¢ Â•Ω„Åç„Å™„É¨„Éô„É´„ÇíÈÅ∏„Çì„ÅßÁ∑¥Áøí<br>‚Ä¢ 10ÂïèÈÄ£Á∂öÊ≠£Ëß£„Åß„É¨„Éô„É´„ÇØ„É™„Ç¢<br>‚Ä¢ Ê≠£Ëß£„Åß„Éù„Ç§„É≥„ÉàÁç≤ÂæóÔºàÂ∞ë„Å™„ÇÅÔºâ</p></div>
<div class="mode-info practice"><h3>üìö Á∑¥Áøí„É¢„Éº„Éâ</h3><p>‚Ä¢ ÂêÑ„É¨„Éô„É´„Åß5ÂïèÈÄ£Á∂öÊ≠£Ëß£„ÅßÊ¨°„ÅÆ„É¨„Éô„É´„Å∏<br>‚Ä¢ ÈñìÈÅï„Åà„Åü„Çâ„Åù„ÅÆ„É¨„Éô„É´„ÅÆ„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çã<br>‚Ä¢ „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Åß„Éú„Éº„Éä„Çπ„Éù„Ç§„É≥„ÉàÔºà‰∏≠Á®ãÂ∫¶Ôºâ</p></div>
<div class="mode-info summary"><h3>üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</h3><p>‚Ä¢ ÂÖ®10„É¨„Éô„É´√óÂêÑ5ÂïèÔºùË®à50Âïè„Å´ÊåëÊà¶<br>‚Ä¢ ‰∏ÄÂïè„Åß„ÇÇÈñìÈÅï„Åà„Çã„Å®„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº<br>‚Ä¢ „ÇØ„É™„Ç¢ÊôÇÈñì„Å´Âøú„Åò„Å¶Â§ßÈáè„Éù„Ç§„É≥„ÉàÁç≤Âæó<br>‚Ä¢ <strong>„ÇØ„É™„Ç¢„ÅßÈö†„Åó„Çπ„ÉÜ„Éº„Ç∏Ëß£ÊîæÔºÅ</strong></p></div>
<div id="hiddenModeInfo" class="mode-info hidden" style="display:none"><h3>üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</h3><p>‚Ä¢ Ë∂ÖÈ´òÈõ£Â∫¶„ÅÆÂàÜÊï∞„ÅÆÂâ≤„ÇäÁÆóÂïèÈ°å„Å´ÊåëÊà¶<br>‚Ä¢ ÂÖ®10Âïè„ÇØ„É™„Ç¢„Åß„ÄåÂàÜÊï∞„ÅÆÂâ≤„ÇäÁÆó„Éû„Çπ„Çø„Éº„Äç„ÅÆÁß∞Âè∑Áç≤Âæó<br>‚Ä¢ Ê¥æÊâã„Å™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßÁ•ùÁ¶èÔºÅ</p></div>
</div>
<button class="mode-btn select" onclick="showLevelSelect()">üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</button>
<button class="mode-btn practice" onclick="selectMode('practice')">üìö Á∑¥Áøí„É¢„Éº„Éâ</button>
<button class="mode-btn" onclick="selectMode('summary')">üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</button>
<button id="hiddenStageBtn" class="mode-btn hidden" onclick="selectMode('hidden')" style="display:none">üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</button>
<div style="margin-top: 20px;">
    <button onclick="displayFirebaseRanking()">üåç „Ç∞„É≠„Éº„Éê„É´„É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫</button>
</div>
</div>

<div id="levelSelect" style="display:none">
<h2>üéÆ „É¨„Éô„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
<div class="level-select">
<div class="level-btn" onclick="selectLevel(1)"><h4>‚ûó „É¨„Éô„É´1</h4><p>ÂàÜÊï∞√∑ÂàÜÊï∞</p></div>
<div class="level-btn" onclick="selectLevel(2)"><h4>üî¢ „É¨„Éô„É´2</h4><p>ÂàÜÊï∞√∑ÂàÜÊï∞√óÂàÜÊï∞</p></div>
<div class="level-btn" onclick="selectLevel(3)"><h4>üî≤ „É¨„Éô„É´3</h4><p>Êï¥Êï∞√∑ÂàÜÊï∞„ÄÅÂ∏ØÂàÜÊï∞√∑ÂàÜÊï∞</p></div>
<div class="level-btn" onclick="selectLevel(4)"><h4>‚öñÔ∏è „É¨„Éô„É´4</h4><p>Â§ßÂ∞èÊØîËºÉ</p></div>
<div class="level-btn" onclick="selectLevel(5)"><h4>üìù „É¨„Éô„É´5</h4><p>Âºè„Çí‰Ωú„ÇãÂïèÈ°å</p></div>
<div class="level-btn" onclick="selectLevel(6)"><h4>üîÄ „É¨„Éô„É´6</h4><p>Â∞èÊï∞„ÉªÊï¥Êï∞„ÉªÂàÜÊï∞„ÅÆÊ∑∑ÂêàË®àÁÆó</p></div>
<div class="level-btn" onclick="selectLevel(7)"><h4>‚è∞ „É¨„Éô„É´7</h4><p>ÂàÜÊï∞„ÅßË°®„ÅôÔºàÊôÇÈñì„ÉªÈï∑„ÅïÔºâ</p></div>
<div class="level-btn" onclick="selectLevel(8)"><h4>üìä „É¨„Éô„É´8</h4><p>ÂàÜÊï∞„Çí‰Ωø„Å£„ÅüÊñáÁ´†È°å</p></div>
<div class="level-btn" onclick="selectLevel(9)"><h4>‚úñÔ∏è „É¨„Éô„É´9</h4><p>ÂàÜÊï∞„ÅÆÂÄç</p></div>
<div class="level-btn" onclick="selectLevel(10)"><h4>üëë „É¨„Éô„É´10</h4><p>„ÇÇ„Å®„Å´„Åô„ÇãÂ§ß„Åç„Åï„ÇíÊ±Ç„ÇÅ„Çã</p></div>
</div>
<button onclick="backToStart()">„Éà„ÉÉ„ÉóÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
</div>

<div id="game" style="display:none">
<div class="info">
<div id="modeDisplay"></div>
<div>„É¨„Éô„É´<span id="lv">1</span>/10 - <span id="lvInfo"></span></div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>
<div id="levelProgress"></div>
<div id="sessionPoints" class="session-points" style="display:none">‰ªäÂõû„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥: <span id="sessionPointsValue">0</span>P</div>
</div>

<div id="timerDisplay" class="timer" style="display:none">‚è±Ô∏è ÁµåÈÅéÊôÇÈñì: <span id="timer">00:00</span></div>

<div class="nav-buttons">
<button class="nav-btn" onclick="backToStart()">„Éà„ÉÉ„ÉóÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
<button class="nav-btn" id="levelSelectBtn" onclick="backToLevelSelect()" style="display:none">„É¨„Éô„É´ÈÅ∏Êäû„Å´„ÇÇ„Å©„Çã</button>
</div>

<div class="level-indicator" id="levelIndicator"></div>
<div class="monster" id="monster">‚ûó</div>
<div class="question" id="q"></div>

<div id="answerSections" class="answer-sections">
<div class="answer-section">
<h3>ÂàÜÊï∞„ÅßÁ≠î„Åà„ÇãÔºàÂøÖ„ÅöÁ¥ÑÂàÜÔºâ</h3>
<div class="fraction-input">
<input type="number" id="n" placeholder="ÂàÜÂ≠ê" min="0">
<div class="fraction-line"></div>
<input type="number" id="d" placeholder="ÂàÜÊØç" min="1">
</div>
<div id="fUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitFraction()">ÂàÜÊï∞„ÅßÁ≠î„Åà„Çã</button>
</div>

<div class="answer-section" id="mixedSection" style="display:none">
<h3>Â∏ØÂàÜÊï∞„ÅßÁ≠î„Åà„ÇãÔºàÂøÖ„ÅöÁ¥ÑÂàÜÔºâ</h3>
<div class="mixed-input">
<input type="number" id="mw" placeholder="Êï¥Êï∞" min="0">
<div class="fraction-input" style="margin:0">
<input type="number" id="mn" placeholder="ÂàÜÂ≠ê" min="0">
<div class="fraction-line"></div>
<input type="number" id="md" placeholder="ÂàÜÊØç" min="1">
</div>
</div>
<div id="mUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitMixed()">Â∏ØÂàÜÊï∞„ÅßÁ≠î„Åà„Çã</button>
</div>

<div class="answer-section">
<h3>Êï¥Êï∞„ÉªÂ∞èÊï∞„ÅßÁ≠î„Åà„Çã</h3>
<div class="normal-input">
<input type="text" id="norm" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ">
<div id="nUnit" class="unit-display" style="display:none"></div>
</div>
<button class="submit-btn" onclick="submitNormal()">Êï¥Êï∞„ÉªÂ∞èÊï∞„ÅßÁ≠î„Åà„Çã</button>
</div>
</div>

<div id="formulaSection" class="answer-sections" style="display:none">
<div class="formula-section">
<h3>Âºè„Çí‰Ωú„ÇãÔºàË®àÁÆó„ÅØ„Åó„Å™„ÅÑÔºâ</h3>
<div class="formula-input">
<div class="formula-builder">
<input type="number" id="f1n" placeholder="ÂàÜÂ≠ê" min="0">
<span>/</span>
<input type="number" id="f1d" placeholder="ÂàÜÊØç" min="1">
<select id="operator">
<option value="">Ë®òÂè∑ÈÅ∏Êäû</option>
<option value="√∑">√∑</option>
<option value="√ó">√ó</option>
<option value="+">+</option>
<option value="-">-</option>
</select>
<input type="number" id="f2n" placeholder="ÂàÜÂ≠ê" min="0">
<span>/</span>
<input type="number" id="f2d" placeholder="ÂàÜÊØç" min="1">
</div>
<div class="formula-preview" id="formulaPreview">Âºè„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>
</div>
<button class="submit-btn" onclick="submitFormula()">Âºè„ÅßÁ≠î„Åà„Çã</button>
</div>
</div>

<div id="comparisonInput" style="display:none" class="comparison-options">
<button class="comparison-btn" onclick="selectComparison(this, 'left')">Â∑¶„Åå„Çè</button>
<button class="comparison-btn" onclick="selectComparison(this, 'right')">Âè≥„Åå„Çè</button>
<button class="comparison-btn" onclick="selectComparison(this, 'equal')">Âêå„Åò</button>
<br>
<button class="submit-btn" onclick="submitComparison()" style="margin-top:15px">Á≠î„Åà„Çã</button>
</div>

<div id="wrong" style="display:none">
<div id="almostMsg" class="almost-msg" style="display:none"><strong>Á¥ÑÂàÜ„Åß„Åç„Åæ„ÅôÔºÅ</strong><br><span id="almostText"></span></div>
<div id="wrongMsg" class="error-msg">„Åæ„Å°„Åå„ÅÑ„Åß„Åô„ÄÇ</div>
<div id="correctAnswer" class="correct-answer" style="display:none"><strong>Ê≠£Ëß£Ôºö</strong><span id="correctText"></span></div>
<div id="practiceMsg" style="display:none"><p>„Åì„ÅÆ„É¨„Éô„É´„ÅÆ„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çä„Åæ„Åô„ÄÇÈ†ëÂºµ„Å£„Å¶ÔºÅ</p></div>
<div id="selectMsg" style="display:none"><p>ÈÄ£Á∂öÊ≠£Ëß£„Ç´„Ç¶„É≥„Éà„Åå0„Å´Êàª„Çä„Åæ„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p></div>
<button onclick="retry()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
<button onclick="next()">„Å§„Åé„Å∏</button>
<button id="backToSelectBtn" onclick="backToLevelSelect()" style="display:none">„É¨„Éô„É´ÈÅ∏Êäû„Å´Êàª„Çã</button>
</div>

<div class="status">
<span>„Çπ„Ç≥„Ç¢: <span id="score">0</span></span>
<span id="totalQ" style="display:none"> / 50Âïè‰∏≠</span>
<span id="hiddenQ" style="display:none"> / 10Âïè‰∏≠</span>
<span id="selectQ" style="display:none"> / 10Âïè‰∏≠</span>
</div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h1>
<div class="monster" style="font-size:120px">üòµ</div>
<h2>ÊÆãÂøµÔºÅ</h2>
<div class="info">
<p>Âà∞ÈÅî„É¨„Éô„É´: <span id="finalLv"></span>/10</p>
<p>Ê≠£Ëß£Êï∞: <span id="finalScore1"></span>Âïè</p>
<p id="finalTime" style="display:none">ÁµåÈÅéÊôÇÈñì: <span id="finalTimeValue"></span></p>
<div id="gameoverPoints" class="points-earned" style="display:none">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="gameoverPointsValue">0</span>P</div>
</div>
<div id="globalRankingGameover" class="global-ranking">
<h3>üåç ÂÖ®‰Ωì„É©„É≥„Ç≠„É≥„Ç∞</h3>
<div id="globalRankingListGameover"></div>
</div>
<button onclick="restart()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>üéâ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ üéâ</h1>
<div class="monster" style="font-size:120px">üëë</div>
<h2>„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅÂÖ®„É¨„Éô„É´Âà∂Ë¶áÔºÅ</h2>
<div class="info">
<p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore2"></span>ÂïèÊ≠£Ëß£</p>
<p id="clearTime">„ÇØ„É™„Ç¢ÊôÇÈñì: <span id="clearTimeValue"></span></p>
<div id="pointsEarned" class="points-earned" style="display:none">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="earnedPoints">0</span>P</div>
</div>
<div id="globalRankingClear" class="global-ranking" style="display:none">
<h3>üåç ÂÖ®‰Ωì„É©„É≥„Ç≠„É≥„Ç∞</h3>
<div id="globalRankingListClear"></div>
</div>
<div id="hiddenStageUnlock" class="hidden-stage-unlock" style="display:none;padding:20px;margin:20px;border-radius:15px;">
<h3>üåü Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÅåËß£Êîæ„Åï„Çå„Åæ„Åó„ÅüÔºÅ üåü</h3>
<p>‰ªä„Åô„ÅêÈö†„Åó„Çπ„ÉÜ„Éº„Ç∏„Å´ÊåëÊà¶„Åß„Åç„Åæ„ÅôÔºÅ</p>
</div>
<button onclick="restart()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
</div>

<div id="levelClear" style="display:none" class="level-clear-screen">
<h1>üéâ „É¨„Éô„É´„ÇØ„É™„Ç¢ÔºÅ üéâ</h1>
<div class="monster" style="font-size:120px">üèÜ</div>
<h2>„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ„É¨„Éô„É´<span id="clearedLevel"></span>„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ</h2>
<div class="info">
<p>10ÂïèÈÄ£Á∂öÊ≠£Ëß£ÈÅîÊàêÔºÅ</p>
<div id="levelClearPoints" class="points-earned">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="levelClearPointsValue">0</span>P</div>
</div>
<button onclick="backToLevelSelect()">„É¨„Éô„É´ÈÅ∏Êäû„Å´Êàª„Çã</button>
</div>

<div id="hiddenClear" style="display:none">
<div style="background:linear-gradient(45deg,#ff9a9e,#fecfef,#a8e6cf,#dcedc1);padding:40px;border-radius:20px;animation:rainbow 3s infinite;">
<h1>üåü Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ üåü</h1>
<div class="monster master-celebration" style="font-size:150px;">üëë</div>
<h2>üèÜ ÂàÜÊï∞„ÅÆÂâ≤„ÇäÁÆó„Éû„Çπ„Çø„ÉºË™ïÁîüÔºÅ üèÜ</h2>
<p style="font-size:20px;color:#d32f2f;font-weight:bold;">„ÅÇ„Å™„Åü„ÅØÁúü„ÅÆÂàÜÊï∞„ÅÆÂâ≤„ÇäÁÆó„ÅÆÈÅî‰∫∫„Åß„ÅôÔºÅ</p>
<div style="margin:20px 0;font-size:18px;">
<p>Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏ÂÖ®10ÂïèÂÆåÂÖ®Âà∂Ë¶á</p>
<p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="hiddenFinalScore"></span>ÂïèÊ≠£Ëß£</p>
<div id="hiddenPointsEarned" class="points-earned" style="display:none">üéâ Áç≤Âæó„Éù„Ç§„É≥„Éà: <span id="hiddenEarnedPoints">0</span>P</div>
</div>
<div id="globalRankingHidden" class="global-ranking" style="display:none">
<h3>üåç ÂÖ®‰Ωì„É©„É≥„Ç≠„É≥„Ç∞</h3>
<div id="globalRankingListHidden"></div>
</div>
<button onclick="restart()" style="padding:15px 30px;font-size:20px;background:#4CAF50;color:white;border:none;border-radius:10px;cursor:pointer;">„Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
</div>
</div>

<div id="celebration" class="correct-celebration"></div>

<script>
// FirebaseÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞
async function savePlayerScore(playerId, points) {
    try {
        const playerRef = window.firestore.doc(window.db, 'players', playerId);
        
        const docSnap = await window.firestore.getDoc(playerRef);
        let shouldUpdate = true;
        
        if (docSnap.exists()) {
            const existingPoints = docSnap.data().totalPoints || 0;
            shouldUpdate = points > existingPoints;
        }
        
        if (shouldUpdate) {
            await window.firestore.setDoc(playerRef, {
                playerId: playerId,
                totalPoints: points,
                lastUpdate: window.firestore.serverTimestamp()
            }, { merge: true });
            
            console.log('„Çπ„Ç≥„Ç¢„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü:', points);
            return true;
        } else {
            console.log('Êó¢Â≠ò„ÅÆ„Çπ„Ç≥„Ç¢„ÅÆÊñπ„ÅåÈ´ò„ÅÑ„Åü„ÇÅÊõ¥Êñ∞„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü');
            return false;
        }
    } catch (error) {
        console.error('„Çπ„Ç≥„Ç¢‰øùÂ≠ò„Ç®„É©„Éº:', error);
        return false;
    }
}

async function fetchTopRanking(limitCount = 10) {
    try {
        const rankingQuery = window.firestore.query(
            window.firestore.collection(window.db, 'players'),
            window.firestore.orderBy('totalPoints', 'desc'),
            window.firestore.limit(limitCount)
        );
        
        const querySnapshot = await window.firestore.getDocs(rankingQuery);
        const rankings = [];
        
        querySnapshot.forEach((doc, index) => {
            const data = doc.data();
            rankings.push({
                rank: index + 1,
                playerId: data.playerId,
                totalPoints: data.totalPoints,
                lastUpdate: data.lastUpdate
            });
        });
        
        return rankings;
    } catch (error) {
        console.error('„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó„Ç®„É©„Éº:', error);
        return [];
    }
}

async function getPlayerRank(playerId, playerPoints) {
    try {
        const allPlayersQuery = window.firestore.query(
            window.firestore.collection(window.db, 'players'),
            window.firestore.orderBy('totalPoints', 'desc')
        );
        
        const querySnapshot = await window.firestore.getDocs(allPlayersQuery);
        let rank = 1;
        
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.totalPoints > playerPoints) {
                rank++;
            }
        });
        
        return rank;
    } catch (error) {
        console.error('È†Ü‰ΩçÂèñÂæó„Ç®„É©„Éº:', error);
        return null;
    }
}

async function displayFirebaseRanking() {
    const rankings = await fetchTopRanking(10);
    const myRank = await getPlayerRank(playerId, totalPoints);
    
    const rankingDialog = document.createElement('div');
    rankingDialog.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: rgba(0,0,0,0.8); z-index: 2000; 
        display: flex; align-items: center; justify-content: center;
    `;
    
    let rankingHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
            <h2 style="color: #f57c00; margin-bottom: 20px; text-align: center;">üåç „Ç∞„É≠„Éº„Éê„É´„É©„É≥„Ç≠„É≥„Ç∞</h2>
    `;
    
    if (rankings.length === 0) {
        rankingHTML += '<p style="text-align: center;">„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    } else {
        const medals = ["ü•á", "ü•à", "ü•â"];
        rankings.forEach((ranking, index) => {
            const medal = index < 3 ? medals[index] : `${index + 1}‰Ωç`;
            const isMyRank = ranking.playerId === playerId ? 'background: #e8f5e8; border: 2px solid #4caf50; font-weight: bold;' : 'background: #fff8e1;';
            
            rankingHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; 
                           padding: 10px 15px; margin: 5px 0; border-radius: 5px; ${isMyRank}">
                    <span><span style="font-size: 18px; margin-right: 10px;">${medal}</span></span>
                    <span>ID: ${ranking.playerId}</span>
                    <span>${ranking.totalPoints}P</span>
                </div>
            `;
        });
        
        if (myRank <= 10) {
            rankingHTML += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd;">
                    <h4 style="text-align: center; color: #333;">„ÅÇ„Å™„Åü„ÅÆÈ†Ü‰Ωç</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; 
                               padding: 10px 15px; margin: 5px 0; border-radius: 5px; 
                               background: #e8f5e8; border: 2px solid #4caf50; font-weight: bold;">
                        <span><strong>${myRank || 'ÂúèÂ§ñ'}‰Ωç</strong></span>
                        <span><strong>ID: ${playerId}</strong></span>
                        <span><strong>${totalPoints}P</strong></span>
                    </div>
                </div>
            `;
        }
    }
    
    rankingHTML += `
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="margin-top: 20px; padding: 12px 24px; font-size: 16px; 
                           background: #4CAF50; color: white; border: none; border-radius: 8px; 
                           cursor: pointer; display: block; margin-left: auto; margin-right: auto;">
                Èñâ„Åò„Çã
            </button>
        </div>
    `;
    
    rankingDialog.innerHTML = rankingHTML;
    document.body.appendChild(rankingDialog);
}

const $=id=>document.getElementById(id)||{style:{},textContent:'',innerHTML:'',value:'',classList:{add:()=>{},remove:()=>{}},appendChild:()=>{},remove:()=>{},focus:()=>{}};
let state={score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedComparison:null,selectQCount:0,startTime:null,timerInterval:null,hiddenQ:0,sessionPoints:0,selectCorrectCount:0,clearedLevels:new Set()};
const monsters=["‚ûó","üî¢","üî≤","‚öñÔ∏è","üìù","üîÄ","‚è∞","üìä","‚úñÔ∏è","üëë"];
const lvNames=["ÂàÜÊï∞√∑ÂàÜÊï∞","ÂàÜÊï∞√∑ÂàÜÊï∞√óÂàÜÊï∞","Êï¥Êï∞√∑ÂàÜÊï∞„ÄÅÂ∏ØÂàÜÊï∞√∑ÂàÜÊï∞","Â§ßÂ∞èÊØîËºÉ","Âºè„Çí‰Ωú„ÇãÂïèÈ°å","Â∞èÊï∞„ÉªÊï¥Êï∞„ÉªÂàÜÊï∞„ÅÆÊ∑∑ÂêàË®àÁÆó","ÂàÜÊï∞„ÅßË°®„ÅôÔºàÊôÇÈñì„ÉªÈï∑„ÅïÔºâ","ÂàÜÊï∞„Çí‰Ωø„Å£„ÅüÊñáÁ´†È°å","ÂàÜÊï∞„ÅÆÂÄç","„ÇÇ„Å®„Å´„Åô„ÇãÂ§ß„Åç„Åï„ÇíÊ±Ç„ÇÅ„Çã"];
let totalPoints=0,hiddenStageAvailable=false,playerId='';

function generatePlayerId(){
    const now=new Date();
    const year=now.getFullYear();
    const month=(now.getMonth()+1).toString().padStart(2,'0');
    const day=now.getDate().toString().padStart(2,'0');
    const hour=now.getHours().toString().padStart(2,'0');
    const minute=now.getMinutes().toString().padStart(2,'0');
    const second=now.getSeconds().toString().padStart(2,'0');
    return`${year}${month}${day}${hour}${minute}${second}`;
}

function initializePlayerId(){
    try{
        playerId=localStorage.getItem('playerId');
        if(!playerId){
            playerId=generatePlayerId();
            localStorage.setItem('playerId',playerId);
        }
    }catch(e){
        playerId=generatePlayerId();
    }
}

function loadClearedLevels(){
    try{
        const saved=localStorage.getItem('clearedLevels');
        if(saved){
            state.clearedLevels=new Set(JSON.parse(saved));
        }
    }catch(e){}
}

function saveClearedLevels(){
    try{
        localStorage.setItem('clearedLevels',JSON.stringify([...state.clearedLevels]));
    }catch(e){}
}

function updateLevelSelectDisplay(){
    for(let i=1;i<=10;i++){
        const levelBtn=document.querySelector(`.level-btn:nth-child(${i})`);
        if(levelBtn){
            if(state.clearedLevels.has(i)){
                levelBtn.classList.add('cleared');
            }else{
                levelBtn.classList.remove('cleared');
            }
        }
    }
}

function saveToGlobalRanking(points){
    try{
        let globalRanking=JSON.parse(localStorage.getItem('globalRanking')||'[]');
        const existingIndex=globalRanking.findIndex(entry=>entry.id===playerId);
        
        if(existingIndex>=0){
            if(globalRanking[existingIndex].points<points){
                globalRanking[existingIndex].points=points;
                globalRanking[existingIndex].lastUpdate=new Date().toISOString();
            }
        }else{
            globalRanking.push({
                id:playerId,
                points:points,
                lastUpdate:new Date().toISOString()
            });
        }
        
        globalRanking.sort((a,b)=>b.points-a.points);
        globalRanking=globalRanking.slice(0,1000);
        localStorage.setItem('globalRanking',JSON.stringify(globalRanking));
        return globalRanking;
    }catch(e){
        return[];
    }
}

function displayGlobalRanking(containerId,myRankId){
    const globalRanking=saveToGlobalRanking(totalPoints);
    const myRank=globalRanking.findIndex(entry=>entry.id===playerId)+1;
    
    $(containerId.replace('#','')).style.display="block";
    const rankingList=$(containerId.replace('#','')+'List');
    rankingList.innerHTML="";
    
    const medals=["ü•á","ü•à","ü•â"];
    for(let i=0;i<Math.min(10,globalRanking.length);i++){
        const rankDiv=document.createElement("div");
        rankDiv.className="global-ranking-item";
        if(globalRanking[i].id===playerId)rankDiv.classList.add("my-rank");
        
        const medal = i < 3 ? medals[i] : `${i+1}‰Ωç`;
        rankDiv.innerHTML=`
            <span><span class="rank-medal">${medal}</span></span>
            <span>ID: ${globalRanking[i].id}</span>
            <span>${globalRanking[i].points}P</span>
        `;
        rankingList.appendChild(rankDiv);
    }
    
    if(myRankId && myRank <= 10){
        const myRankDiv=$(myRankId.replace('#',''));
        myRankDiv.innerHTML=`
            <div class="global-ranking-item my-rank">
                <span><strong>${myRank}‰Ωç</strong></span>
                <span><strong>ID: ${playerId}</strong></span>
                <span><strong>${totalPoints}P</strong></span>
            </div>
        `;
    }
}

function enableHiddenStage(){hiddenStageAvailable=true;$("hiddenStageBtn").style.display="inline-block";$("hiddenModeInfo").style.display="block"}
function disableHiddenStage(){hiddenStageAvailable=false;$("hiddenStageBtn").style.display="none";$("hiddenModeInfo").style.display="none"}

try{totalPoints=parseInt(localStorage.getItem('totalPoints')||'0')}catch(e){}
const titles={divisionMaster:{name:"ÂàÜÊï∞„ÅÆÂâ≤„ÇäÁÆó„Éû„Çπ„Çø„Éº",description:"Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏„ÇíÂà∂Ë¶á„Åó„ÅüÁúü„ÅÆÂàÜÊï∞„ÅÆÂâ≤„ÇäÁÆó„ÅÆÈÅî‰∫∫",unlocked:false}};

window.addEventListener('load',()=>{
    initializePlayerId();
    loadClearedLevels();
    $("playerIdDisplay").style.display="block";
    $("playerId").textContent=playerId;
    if(totalPoints>0){
        $("pointsDisplay").style.display="block";
        $("totalPoints").textContent=totalPoints;
    }
    
    // Âºè„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    ['f1n', 'f1d', 'operator', 'f2n', 'f2d'].forEach(id => {
        $(id).addEventListener('input', updateFormulaPreview);
        $(id).addEventListener('change', updateFormulaPreview);
    });
});

function updateFormulaPreview() {
    const f1n = $("f1n").value;
    const f1d = $("f1d").value;
    const operator = $("operator").value;
    const f2n = $("f2n").value;
    const f2d = $("f2d").value;
    
    let preview = "";
    if (f1n && f1d) {
        preview += `${f1n}/${f1d}`;
    }
    if (operator) {
        preview += ` ${operator} `;
    }
    if (f2n && f2d) {
        preview += `${f2n}/${f2d}`;
    }
    
    $("formulaPreview").textContent = preview || "Âºè„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô";
}

const gcd=(a,b)=>b?gcd(b,a%b):a;
const R=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
function simplify(n,d){if(d<0){n=-n;d=-d}const g=gcd(Math.abs(n),Math.abs(d));return[n/g,d/g]}
function randFrac(maxN=10,maxD=10){let n,d;do{n=R(1,maxN);d=R(2,maxD)}while(gcd(n,d)!==1||n>=d);return[n,d]}
function frac(n,d){return`<span class="fraction-display"><span class="numerator">${n}</span><span class="fraction-bar"></span><span class="denominator">${d}</span></span>`}
function mixedFrac(w,n,d){if(n>=d){w+=Math.floor(n/d);n=n%d}return n===0?`${w}`:`${w} ${frac(n,d)}`}
function formatAnswer(n,d,u=""){const[sn,sd]=simplify(n,d);return sd===1?sn+u:`${sn}/${sd}`+u}
function formatTime(s){const m=Math.floor(s/60);return`${m.toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`}

function calculateClearPoints(clearTime){
    const basePoints = 2000;
    if(clearTime<=300)return basePoints * 10;
    else if(clearTime<=600)return 1500 * 10;
    else if(clearTime<=900)return 1200 * 10;
    else if(clearTime<=1200)return 1000 * 10;
    else if(clearTime<=1800)return 800 * 10;
    else return 500 * 10;
}

function calculateLevelPoints(level,mode){
    const basePoints = level*50;
    if(mode==='practice')return Math.floor(basePoints*0.3);
    else if(mode==='select')return Math.floor(basePoints*0.5);
    else return basePoints;
}

function calculateCorrectPoints(level,mode){
    const basePoints = Math.min(level*10,100);
    if(mode==='practice')return Math.floor(basePoints*0.3);
    else if(mode==='select')return Math.floor(basePoints*0.1);
    else return basePoints;
}

async function addPoints(points,showAnimation=true){
    totalPoints+=points;
    state.sessionPoints+=points;
    try{localStorage.setItem('totalPoints',totalPoints.toString())}catch(e){}
    $("totalPoints").textContent=totalPoints;
    $("sessionPointsValue").textContent=state.sessionPoints;
    $("pointsDisplay").style.display="block";
    $("sessionPoints").style.display="block";
    
    await savePlayerScore(playerId, totalPoints);
    
    if(showAnimation)showPointsAnimation(points);
}

function showPointsAnimation(points){
    const pointsDiv=document.createElement('div');
    pointsDiv.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(45deg,#ffd700,#ffed4e);color:#d32f2f;padding:20px;border-radius:15px;font-size:24px;font-weight:bold;z-index:3000;animation:pointsEarn 2s;border:3px solid #ff6b6b;">+${points}P Áç≤ÂæóÔºÅ</div>`;
    document.body.appendChild(pointsDiv);
    setTimeout(()=>pointsDiv.remove(),2000);
}

function startTimer(){
    if(state.mode==='summary'||state.mode==='hidden'){
        state.startTime=Date.now();
        $("timerDisplay").style.display="block";
        state.timerInterval=setInterval(updateTimer,1000);
    }
}

function updateTimer(){
    if(state.startTime){
        const elapsed=Math.floor((Date.now()-state.startTime)/1000);
        $("timer").textContent=formatTime(elapsed);
    }
}

function stopTimer(){
    if(state.timerInterval){
        clearInterval(state.timerInterval);
        state.timerInterval=null;
    }
}

function getElapsedTime(){
    return state.startTime?Math.floor((Date.now()-state.startTime)/1000):0;
}

function generateHiddenProblem(){
    const type=R(1,5);
    switch(type){
        case 1:{
            // Ë§áÈõë„Å™ÂàÜÊï∞„ÅÆÂâ≤„ÇäÁÆó
            const[n1,d1]=randFrac(15,20);
            const[n2,d2]=randFrac(15,20);
            const[n3,d3]=randFrac(15,20);
            return{q:`${frac(n1,d1)} √∑ ${frac(n2,d2)} √∑ ${frac(n3,d3)} =`,n:n1*d2*d3,d:d1*n2*n3,type:'fraction',mixed:false};
        }
        case 2:{
            // Â∏ØÂàÜÊï∞„ÇíÂê´„ÇÄË§áÈõë„Å™Ë®àÁÆó
            const w1=R(2,4),d1=R(5,8),n1=R(1,d1-1);
            const[n2,d2]=randFrac(12,15);
            const i1=w1*d1+n1;
            return{q:`${mixedFrac(w1,n1,d1)} √∑ ${frac(n2,d2)} √ó ${frac(n2,d2)} =`,n:i1,d:d1,type:'fraction',mixed:true};
        }
        case 3:{
            // ÊñáÁ´†È°åÔºàË§áÈõëÔºâ
            const total=R(120,200);
            const[n1,d1]=randFrac(8,15);
            const[n2,d2]=randFrac(8,15);
            return{q:`${total}ÂÄã„ÅÆ„ÅäËèìÂ≠ê„Çí${frac(n1,d1)}„Åö„Å§ÂàÜ„Åë„Çã„Å®‰Ωï‰∫∫„Å´ÂàÜ„Åë„Çâ„Çå„Åæ„Åô„ÅãÔºü„Åï„Çâ„Å´„Åù„ÅÆ‰∫∫Êï∞„Çí${frac(n2,d2)}„ÅßÂâ≤„Çã„Å®‰Ωï‰∫∫„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü`,n:total*d1*d2,d:n1*n2,u:"‰∫∫",type:'fraction',mixed:false};
        }
        case 4:{
            // ÊôÇÈñì„ÅÆË§áÈõë„Å™Ë®àÁÆó
            const hours=R(2,5);
            const[n1,d1]=randFrac(8,12);
            const[n2,d2]=randFrac(6,10);
            return{q:`${hours}ÊôÇÈñì„ÅÆ${frac(n1,d1)}„Çí${frac(n2,d2)}„ÅßÂâ≤„Çã„Å®‰ΩïÂàÜ„Åß„Åô„ÅãÔºü`,n:hours*60*n1*d2,d:d1*n2,u:"ÂàÜ",type:'fraction',mixed:false};
        }
        case 5:{
            // ÊØîËºÉÂïèÈ°åÔºàË§áÈõëÔºâ
            const[n1,d1]=randFrac(20,30);
            const[n2,d2]=randFrac(20,30);
            const[n3,d3]=randFrac(20,30);
            const left=(n1*d2*d3)/(d1*n2*n3);
            const right=1;
            return{q:`${frac(n1,d1)} √∑ ${frac(n2,d2)} √∑ ${frac(n3,d3)} „Å® 1 „ÇíÊØî„Åπ„Å¶„ÄÅ„Å©„Å°„Çâ„ÅåÂ§ß„Åç„ÅÑ„ÅãÁ≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ`,left:left,right:right,type:'comparison'};
        }
    }
}

function generateProblem(lv){
    if(state.mode==='hidden')return generateHiddenProblem();
    switch(lv){
        case 1:{
            // ÂàÜÊï∞√∑ÂàÜÊï∞
            const[n1,d1]=randFrac(8,12);
            const[n2,d2]=randFrac(8,12);
            return{q:`${frac(n1,d1)} √∑ ${frac(n2,d2)} =`,n:n1*d2,d:d1*n2,type:'fraction',mixed:false};
        }
        case 2:{
            // ÂàÜÊï∞√∑ÂàÜÊï∞√óÂàÜÊï∞ „Åæ„Åü„ÅØ ÂàÜÊï∞√óÂàÜÊï∞√∑ÂàÜÊï∞
            const[n1,d1]=randFrac(6,10);
            const[n2,d2]=randFrac(6,10);
            const[n3,d3]=randFrac(6,10);
            if(R(1,2)===1){
                return{q:`${frac(n1,d1)} √∑ ${frac(n2,d2)} √ó ${frac(n3,d3)} =`,n:n1*d2*n3,d:d1*n2*d3,type:'fraction',mixed:false};
            }else{
                return{q:`${frac(n1,d1)} √ó ${frac(n2,d2)} √∑ ${frac(n3,d3)} =`,n:n1*n2*d3,d:d1*d2*n3,type:'fraction',mixed:false};
            }
        }
        case 3:{
            // Êï¥Êï∞√∑ÂàÜÊï∞„ÄÅÂ∏ØÂàÜÊï∞√∑ÂàÜÊï∞„Å™„Å©
            const type=R(1,4);
            switch(type){
                case 1:{
                    // Êï¥Êï∞√∑ÂàÜÊï∞
                    const i=R(2,8);
                    const[n,d]=randFrac(6,10);
                    return{q:`${i} √∑ ${frac(n,d)} =`,n:i*d,d:n,type:'fraction',mixed:true};
                }
                case 2:{
                    // Â∏ØÂàÜÊï∞√∑ÁúüÂàÜÊï∞
                    const w=R(1,3),d1=R(3,6),n1=R(1,d1-1);
                    const[n2,d2]=randFrac(6,8);
                    const i1=w*d1+n1;
                    return{q:`${mixedFrac(w,n1,d1)} √∑ ${frac(n2,d2)} =`,n:i1*d2,d:d1*n2,type:'fraction',mixed:true};
                }
                case 3:{
                    // ÁúüÂàÜÊï∞√∑Â∏ØÂàÜÊï∞
                    const[n1,d1]=randFrac(6,8);
                    const w=R(1,2),d2=R(3,5),n2=R(1,d2-1);
                    const i2=w*d2+n2;
                    return{q:`${frac(n1,d1)} √∑ ${mixedFrac(w,n2,d2)} =`,n:n1*d2,d:d1*i2,type:'fraction',mixed:false};
                }
                case 4:{
                    // Â∏ØÂàÜÊï∞√∑Â∏ØÂàÜÊï∞
                    const w1=R(1,2),d1=R(3,5),n1=R(1,d1-1);
                    const w2=R(1,2),d2=R(3,5),n2=R(1,d2-1);
                    const i1=w1*d1+n1,i2=w2*d2+n2;
                    return{q:`${mixedFrac(w1,n1,d1)} √∑ ${mixedFrac(w2,n2,d2)} =`,n:i1*d2,d:d1*i2,type:'fraction',mixed:true};
                }
            }
        }
        case 4:{
            // Â§ßÂ∞èÊØîËºÉÔºà‰øÆÊ≠£ÁâàÔºöÁ≠î„Åà„Åå„É©„É≥„ÉÄ„É†„Å´„Å™„Çã„Çà„ÅÜ„Å´Ôºâ
            const type=R(1,3);
            switch(type){
                case 1:{
                    // Êï¥Êï∞√∑ÂàÜÊï∞„Å®Êï¥Êï∞„ÅÆÊØîËºÉ
                    const i=R(3,6);
                    const[n,d]=randFrac(6,10);
                    const leftValue=i*d/n;
                    const rightValue=i;
                    const questionType=R(1,2)===1?"Â§ß„Åç„ÅÑ":"Â∞è„Åï„ÅÑ";
                    return{q:`${i} √∑ ${frac(n,d)} „Å® ${i} „ÇíÊØî„Åπ„Å¶„ÄÅ„Å©„Å°„Çâ„Åå${questionType}„ÅãÁ≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ`,left:leftValue,right:rightValue,type:'comparison',questionType:questionType};
                }
                case 2:{
                    // ÂàÜÊï∞√∑ÂàÜÊï∞„Å®ÂàÜÊï∞„ÅÆÊØîËºÉ
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    const leftValue=(n1*d2)/(d1*n2);
                    const rightValue=n1/d1;
                    const questionType=R(1,2)===1?"Â§ß„Åç„ÅÑ":"Â∞è„Åï„ÅÑ";
                    return{q:`${frac(n1,d1)} √∑ ${frac(n2,d2)} „Å® ${frac(n1,d1)} „ÇíÊØî„Åπ„Å¶„ÄÅ„Å©„Å°„Çâ„Åå${questionType}„ÅãÁ≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ`,left:leftValue,right:rightValue,type:'comparison',questionType:questionType};
                }
                case 3:{
                    // Êï¥Êï∞√∑ÂàÜÊï∞„Å®Êï¥Êï∞„ÅÆÊØîËºÉÔºàÂà•„Éë„Çø„Éº„É≥Ôºâ
                    const i=R(4,8);
                    const[n,d]=randFrac(8,12);
                    const leftValue=i*d/n;
                    const rightValue=i;
                    const questionType=R(1,2)===1?"Â§ß„Åç„ÅÑ":"Â∞è„Åï„ÅÑ";
                    return{q:`${i} √∑ ${frac(n,d)} „Å® ${i} „ÇíÊØî„Åπ„Å¶„ÄÅ„Å©„Å°„Çâ„Åå${questionType}„ÅãÁ≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ`,left:leftValue,right:rightValue,type:'comparison',questionType:questionType};
                }
            }
        }
        case 5:{
            // Âºè„Çí‰Ωú„ÇãÂïèÈ°åÔºà‰øÆÊ≠£ÁâàÔºöÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅÆË®≠ÂÆöÔºâ
            const type=R(1,2);
            switch(type){
                case 1:{
                    // „Éõ„Éº„ÇπÂïèÈ°åÔºà‰øÆÊ≠£ÁâàÔºöÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅÆË®≠ÂÆöÔºâ
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    const unit1=R(1,2)===1?"m":"L";
                    const unit2="kg";
                    const question=R(1,2)===1?"Ôºë"+unit1+"„ÅÆÈáç„Åï„ÇíÊ±Ç„ÇÅ„Åæ„Åó„Çá„ÅÜ":"Ôºë"+unit2+"„ÅÆÈï∑„Åï„ÇíÊ±Ç„ÇÅ„Åæ„Åó„Çá„ÅÜ";
                    if(question.includes("Èáç„Åï„ÇíÊ±Ç„ÇÅ„Åæ„Åó„Çá„ÅÜ")){
                        // n1/d1 unit1„ÅÆÈáç„Åï„Åån2/d2 kg ‚Üí 1unit1„ÅÆÈáç„Åï = n2/d2 √∑ n1/d1
                        return{q:`${frac(n1,d1)}${unit1}„ÅÆÈáç„Åï„Åå${frac(n2,d2)}${unit2}„ÅÆ„Éõ„Éº„Çπ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ${question}`,correctFormula:{n1:n2,d1:d2,op:"√∑",n2:n1,d2:d1},type:'formula'};
                    }else{
                        // n1/d1 unit1„ÅÆÈáç„Åï„Åån2/d2 kg ‚Üí 1kg„ÅÆÈï∑„Åï = n1/d1 √∑ n2/d2
                        return{q:`${frac(n1,d1)}${unit1}„ÅÆÈáç„Åï„Åå${frac(n2,d2)}${unit2}„ÅÆ„Éõ„Éº„Çπ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ${question}`,correctFormula:{n1:n1,d1:d1,op:"√∑",n2:n2,d2:d2},type:'formula'};
                    }
                }
                case 2:{
                    // Á±≥„ÅÆÈáç„ÅïÂïèÈ°åÔºà‰øÆÊ≠£ÁâàÔºöÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅÆË®≠ÂÆöÔºâ
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    const question=R(1,2)===1?"ÔºëÔº¨„ÅÆÈáç„Åï„ÇíÊ±Ç„ÇÅ„Åæ„Åó„Çá„ÅÜ":"ÔºëÔΩãÔΩá„ÅÆ„Åã„Åï„ÇíÊ±Ç„ÇÅ„Åæ„Åó„Çá„ÅÜ";
                    if(question==="ÔºëÔº¨„ÅÆÈáç„Åï„ÇíÊ±Ç„ÇÅ„Åæ„Åó„Çá„ÅÜ"){
                        // Á±≥n1/d1L„ÅÆÈáç„Åï„Åån2/d2kg ‚Üí 1L„ÅÆÈáç„Åï = n2/d2 √∑ n1/d1
                        return{q:`Á±≥${frac(n1,d1)}L„ÅÆÈáç„Åï„ÇíÈáè„Å£„Åü„Çâ${frac(n2,d2)}ÔΩãÔΩá„Åß„Åó„Åü„ÄÇ${question}`,correctFormula:{n1:n2,d1:d2,op:"√∑",n2:n1,d2:d1},type:'formula'};
                    }else{
                        // Á±≥n1/d1L„ÅÆÈáç„Åï„Åån2/d2kg ‚Üí 1kg„ÅÆ„Åã„Åï = n1/d1 √∑ n2/d2
                        return{q:`Á±≥${frac(n1,d1)}L„ÅÆÈáç„Åï„ÇíÈáè„Å£„Åü„Çâ${frac(n2,d2)}ÔΩãÔΩá„Åß„Åó„Åü„ÄÇ${question}`,correctFormula:{n1:n1,d1:d1,op:"√∑",n2:n2,d2:d2},type:'formula'};
                    }
                }
            }
        }
        case 6:{
            // Â∞èÊï∞√∑ÂàÜÊï∞√óÊï¥Êï∞„ÅÆ„Çà„ÅÜ„Å™Ê∑∑ÂêàË®àÁÆó
            const type=R(1,3);
            switch(type){
                case 1:{
                    // Â∞èÊï∞√∑ÂàÜÊï∞√óÊï¥Êï∞
                    const decimal=(R(10,50)/10);
                    const[n,d]=randFrac(6,10);
                    const integer=R(2,6);
                    return{q:`${decimal} √∑ ${frac(n,d)} √ó ${integer} =`,n:decimal*d*integer*10,d:n*10,type:'fraction',mixed:false};
                }
                case 2:{
                    // Êï¥Êï∞√óÂàÜÊï∞√∑Â∞èÊï∞
                    const integer=R(3,8);
                    const[n,d]=randFrac(6,10);
                    const decimal=(R(10,30)/10);
                    return{q:`${integer} √ó ${frac(n,d)} √∑ ${decimal} =`,n:integer*n*10,d:d*decimal*10,type:'fraction',mixed:false};
                }
                case 3:{
                    // ÂàÜÊï∞√óÂ∞èÊï∞√∑Êï¥Êï∞
                    const[n,d]=randFrac(6,10);
                    const decimal=(R(10,40)/10);
                    const integer=R(2,5);
                    return{q:`${frac(n,d)} √ó ${decimal} √∑ ${integer} =`,n:n*decimal*10,d:d*integer*10,type:'fraction',mixed:false};
                }
            }
        }
        case 7:{
            // ÂàÜÊï∞„ÅßË°®„Åó„Åæ„Åó„Çá„ÅÜ
            const type=R(1,4);
            switch(type){
                case 1:{
                    // 7Áßí„ÅØ‰ΩïÂàÜ„Åß„Åô„ÅãÔºü
                    const seconds=R(5,50);
                    return{q:`${seconds}Áßí„ÅØ‰ΩïÂàÜ„Åß„Åô„ÅãÔºü`,n:seconds,d:60,u:"ÂàÜ",type:'fraction',mixed:false};
                }
                case 2:{
                    // 6ÂàÜ„ÅØ‰ΩïÊôÇÈñì„Åß„Åô„ÅãÔºü
                    const minutes=R(5,50);
                    return{q:`${minutes}ÂàÜ„ÅØ‰ΩïÊôÇÈñì„Åß„Åô„ÅãÔºü`,n:minutes,d:60,u:"ÊôÇÈñì",type:'fraction',mixed:false};
                }
                case 3:{
                    // 3ÊôÇÈñì„ÅØ‰ΩïÊó•„Åß„Åô„ÅãÔºü
                    const hours=R(2,20);
                    return{q:`${hours}ÊôÇÈñì„ÅØ‰ΩïÊó•„Åß„Åô„ÅãÔºü`,n:hours,d:24,u:"Êó•",type:'fraction',mixed:false};
                }
                case 4:{
                    // 2ÊôÇÈñì20ÂàÜ„ÅØ‰ΩïÊôÇÈñì„Åß„Åô„ÅãÔºü
                    const hours=R(1,3);
                    const minutes=R(10,50);
                    const totalMinutes=hours*60+minutes;
                    return{q:`${hours}ÊôÇÈñì${minutes}ÂàÜ„ÅØ‰ΩïÊôÇÈñì„Åß„Åô„ÅãÔºü`,n:totalMinutes,d:60,u:"ÊôÇÈñì",type:'fraction',mixed:true};
                }
            }
        }
        case 8:{
            // ÂàÜÊï∞„Çí‰Ωø„Å£„ÅüÊñáÁ´†È°åÔºà‰øÆÊ≠£ÁâàÔºöÁ¥ÑÂàÜ„Åó„ÇÑ„Åô„ÅÑÊï∞Â≠ó„Çí‰ΩøÁî®„Åó„ÄÅÊôÇË®àÂïèÈ°å„ÇíËøΩÂä†Ôºâ
            const type=R(1,3);
            switch(type){
                case 1:{
                    // „Éû„É©„ÇΩ„É≥ÂïèÈ°åÔºàÁ¥ÑÂàÜ„Åó„ÇÑ„Åô„ÅÑÊï∞Â≠ó„Çí‰ΩøÁî®Ôºâ
                    const distance=[24,30,36,42,48,54,60][R(0,6)]; // Á¥ÑÂàÜ„Åó„ÇÑ„Åô„ÅÑË∑ùÈõ¢
                    const hours=R(2,4);
                    const minutes=[15,20,30,40,45][R(0,4)]; // Á¥ÑÂàÜ„Åó„ÇÑ„Åô„ÅÑÂàÜÊï∞„Å´„Å™„ÇãÂàÜ„ÇíÈÅ∏Êäû
                    const totalMinutes=hours*60+minutes;
                    return{q:`„Éû„É©„ÇΩ„É≥„Åß${distance}ÔΩãÔΩç„Çí${hours}ÊôÇÈñì${minutes}ÂàÜ„ÅßËµ∞„Çä„Åæ„Åó„Åü„ÄÇÊôÇÈÄü‰ΩïÔΩãÔΩç„Åß„Åô„ÅãÔºü`,n:distance*60,d:totalMinutes,u:"ÔΩãÔΩç",type:'fraction',mixed:false};
                }
                case 2:{
                    // ‰∏ÄËà¨ÁöÑ„Å™ÈÄüÂ∫¶ÂïèÈ°åÔºàÁ¥ÑÂàÜ„Åó„ÇÑ„Åô„ÅÑÊï∞Â≠ó„Çí‰ΩøÁî®Ôºâ
                    const distance=[24,30,36,42,48,54,60][R(0,6)]; // Á¥ÑÂàÜ„Åó„ÇÑ„Åô„ÅÑË∑ùÈõ¢
                    const hours=R(1,3);
                    const minutes=[12,15,18,20,24,30,36,40,45][R(0,8)]; // Á¥ÑÂàÜ„Åó„ÇÑ„Åô„ÅÑÂàÜÊï∞„Å´„Å™„ÇãÂàÜ
                    const totalMinutes=hours*60+minutes;
                    return{q:`${distance}ÔΩãÔΩç„Çí${hours}ÊôÇÈñì${minutes}ÂàÜ„ÅßÁßªÂãï„Åó„Åæ„Åó„Åü„ÄÇÊôÇÈÄü‰ΩïÔΩãÔΩç„Åß„Åô„ÅãÔºü`,n:distance*60,d:totalMinutes,u:"ÔΩãÔΩç",type:'fraction',mixed:false};
                }
                case 3:{
                    // ÊôÇË®à„ÅÆÈÄ≤„ÅøÊñπÂïèÈ°åÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ
                    const progressSeconds=[6,8,10,12,15,18,20,24][R(0,7)]; // Á¥ÑÂàÜ„Åó„ÇÑ„Åô„ÅÑÁßíÊï∞
                    const targetMinutes=[6,8,10,12,15,18,20,24][R(0,7)]; // Á¥ÑÂàÜ„Åó„ÇÑ„Åô„ÅÑÂàÜÊï∞
                    // progressSecondsÁßí„ÇíÂàÜÊï∞„ÅßË°®„Åô„Å® progressSeconds/60 ÂàÜ
                    // targetMinutesÂàÜÈÄ≤„ÇÄ„ÅÆ„Å´ÂøÖË¶Å„Å™Êó•Êï∞ = targetMinutes √∑ (progressSeconds/60) = targetMinutes √ó 60 √∑ progressSeconds
                    const answerNumerator=targetMinutes*60;
                    const answerDenominator=progressSeconds;
                    return{q:`1Êó•„Å´${progressSeconds}Áßí„Åö„Å§ÈÄ≤„ÇÄÊôÇË®à„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Åì„ÅÆÊôÇË®à„ÅØ‰ΩïÊó•„Åß${targetMinutes}ÂàÜÈÄ≤„Åø„Åæ„Åô„ÅãÔºü${progressSeconds}Áßí„ÇíÂàÜÊï∞„ÅßË°®„Åó„Å¶Ë®àÁÆó„Åó„Å¶Á≠î„Åà„Åæ„Åó„Çá„ÅÜ„ÄÇ`,n:answerNumerator,d:answerDenominator,u:"Êó•",type:'fraction',mixed:false};
                }
            }
        }
        case 9:{
            // ÂàÜÊï∞„ÅÆÂÄç
            const type=R(1,2);
            switch(type){
                case 1:{
                    // „É™„Éú„É≥„ÅÆÂÄçÊï∞ÂïèÈ°å
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    return{q:`Ëµ§„ÅÑ„É™„Éú„É≥„ÅØ${frac(n1,d1)}ÔΩç„Åß„Åô„ÄÇÈùí„ÅÑ„É™„Éú„É≥„ÅØ${frac(n2,d2)}ÔΩç„Åß„Åô„ÄÇÈùí„ÅÑ„É™„Éú„É≥„ÅØËµ§„ÅÑ„É™„Éú„É≥„ÅÆ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,n:n2*d1,d:d2*n1,u:"ÂÄç",type:'fraction',mixed:false};
                }
                case 2:{
                    // ‰∏ÄËà¨ÁöÑ„Å™ÂÄçÊï∞ÂïèÈ°å
                    const[n1,d1]=randFrac(6,10);
                    const[n2,d2]=randFrac(6,10);
                    const item=["„Å≤„ÇÇ","„ÉÜ„Éº„Éó","Êùø"][R(0,2)];
                    return{q:`A„ÅÆ${item}„ÅØ${frac(n1,d1)}ÔΩç„Åß„Åô„ÄÇB„ÅÆ${item}„ÅØ${frac(n2,d2)}ÔΩç„Åß„Åô„ÄÇB„ÅÆ${item}„ÅØA„ÅÆ${item}„ÅÆ‰ΩïÂÄç„Åß„Åô„ÅãÔºü`,n:n2*d1,d:d2*n1,u:"ÂÄç",type:'fraction',mixed:false};
                }
            }
        }
        case 10:{
            // „ÇÇ„Å®„Å´„Åô„ÇãÂ§ß„Åç„Åï„ÇíÊ±Ç„ÇÅ„ÇãÂïèÈ°å
            const type=R(1,2);
            switch(type){
                case 1:{
                    // Êú¨„Å®ÈõëË™å„ÅÆÂïèÈ°å
                    const price=R(600,1200);
                    const[n,d]=randFrac(6,10);
                    return{q:`${price}ÂÜÜ„ÅÆÊú¨„ÇíË≤∑„ÅÑ„Åæ„Åó„Åü„ÄÇ„Åì„ÅÆÊú¨„ÅÆÂÄ§ÊÆµ„ÅØÈõëË™å„ÅÆÂÄ§ÊÆµ„ÅÆ${frac(n,d)}ÂÄç„Åß„Åô„ÄÇÈõëË™å„ÅÆÂÄ§ÊÆµ„ÇíÊ±Ç„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ`,n:price*d,d:n,u:"ÂÜÜ",type:'fraction',mixed:false};
                }
                case 2:{
                    // ‰∏ÄËà¨ÁöÑ„Å™„ÇÇ„Å®„ÅÆÈáèÂïèÈ°å
                    const amount=R(200,800);
                    const[n,d]=randFrac(6,10);
                    const item=["„Éö„É≥","„Éé„Éº„Éà","Ê∂à„Åó„Ç¥„É†"][R(0,2)];
                    return{q:`${amount}ÂÜÜ„ÅÆ${item}„ÇíË≤∑„ÅÑ„Åæ„Åó„Åü„ÄÇ„Åì„ÅÆ${item}„ÅÆÂÄ§ÊÆµ„ÅØÂà•„ÅÆÂïÜÂìÅ„ÅÆ${frac(n,d)}ÂÄç„Åß„Åô„ÄÇÂà•„ÅÆÂïÜÂìÅ„ÅÆÂÄ§ÊÆµ„ÇíÊ±Ç„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ`,n:amount*d,d:n,u:"ÂÜÜ",type:'fraction',mixed:false};
                }
            }
        }
    }
}

// ‰øÆÊ≠£„Åï„Çå„Åü selectLevel Èñ¢Êï∞
function selectLevel(level){
    state.level = level; // „É¨„Éô„É´„ÇíÊ≠£„Åó„ÅèË®≠ÂÆö
    state.score = 0;
    state.lvCount = 0;
    state.totalQ = 0;
    state.qNum = 0;
    state.selectQCount = 0;
    state.selectCorrectCount = 0;
    state.sessionPoints = 0;
    
    $("start").style.display = "none";
    $("levelSelect").style.display = "none";
    $("game").style.display = "block";
    
    state.mode = 'select';
    $("levelSelectBtn").style.display = "inline-block";
    $("selectQ").style.display = "inline-block";
    $("totalQ").style.display = "none";
    $("hiddenQ").style.display = "none";
    $("modeDisplay").innerHTML = `<div class="mode-info select"><strong>üéÆ ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ</strong> - „É¨„Éô„É´${state.level}</div>`;
    $("progressBar").className = "progress-bar select";
    
    updateLevelIndicator();
    updateProgressBar();
    newProblem();
}

function selectMode(mode){
    state.mode=mode;
    state.score=0;
    state.level=1; // Á∑¥Áøí„É¢„Éº„ÉâÁ≠â„Åß„ÅØ1„Åã„ÇâÈñãÂßã
    state.lvCount=0;
    state.totalQ=0;
    state.qNum=0;
    state.selectQCount=0;
    state.hiddenQ=0;
    state.selectCorrectCount=0;
    state.sessionPoints=0;
    
    $("start").style.display="none";
    $("levelSelect").style.display="none";
    $("game").style.display="block";
    
    if(mode==='select'){
        // ÈÅ∏„Åπ„Çã„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„É¨„Éô„É´ÈÅ∏ÊäûÁîªÈù¢„Å´Êàª„Çã
        $("game").style.display="none";
        showLevelSelect();
        return;
    }else if(mode==='practice'){
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
        $("modeDisplay").innerHTML='<div class="mode-info practice"><strong>üìö Á∑¥Áøí„É¢„Éº„Éâ</strong></div>';
        $("progressBar").className="progress-bar practice";
    }else if(mode==='summary'){
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("totalQ").style.display="inline-block";
        $("hiddenQ").style.display="none";
        $("modeDisplay").innerHTML='<div class="mode-info summary"><strong>üéØ „Åæ„Å®„ÇÅ„É¢„Éº„Éâ</strong></div>';
        $("progressBar").className="progress-bar summary";
        startTimer();
    }else if(mode==='hidden'){
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="inline-block";
        $("modeDisplay").innerHTML='<div class="mode-info hidden"><strong>üëë Èö†„Åó„Çπ„ÉÜ„Éº„Ç∏</strong></div>';
        $("progressBar").className="progress-bar hidden";
        startTimer();
    }
    
    updateLevelIndicator();
    updateProgressBar();
    newProblem();
}

function showLevelSelect(){
    $("start").style.display="none";
    $("levelSelect").style.display="block";
    updateLevelSelectDisplay();
}

function backToStart(){
    $("game").style.display="none";
    $("gameover").style.display="none";
    $("clear").style.display="none";
    $("levelClear").style.display="none";
    $("hiddenClear").style.display="none";
    $("levelSelect").style.display="none";
    $("start").style.display="block";
    stopTimer();
    
    if(state.sessionPoints>0){
        $("sessionPoints").style.display="block";
    }
}

function backToLevelSelect(){
    $("game").style.display="none";
    $("levelClear").style.display="none";
    showLevelSelect();
}

function updateLevelIndicator(){
    const indicator=$("levelIndicator");
    indicator.innerHTML="";
    
    if(state.mode==='practice'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(state.completed.has(i))dot.classList.add("completed");
            if(i===state.level)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='summary'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<state.level||(i===state.level&&state.totalQ%5===0&&state.totalQ>0))dot.classList.add("completed");
            if(i===state.level)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='hidden'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<=state.hiddenQ)dot.classList.add("completed");
            if(i===state.hiddenQ+1)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }else if(state.mode==='select'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            if(i<=state.selectCorrectCount)dot.classList.add("completed");
            if(i===state.selectCorrectCount+1)dot.classList.add("current");
            dot.textContent=i;
            indicator.appendChild(dot);
        }
    }
}

function updateProgressBar(){
    const progressBar=$("progressBar");
    let progress=0;
    
    if(state.mode==='practice'){
        progress=(state.lvCount/5)*100;
        $("levelProgress").textContent=`„Åì„ÅÆ„É¨„Éô„É´: ${state.lvCount}/5ÂïèÊ≠£Ëß£`;
    }else if(state.mode==='summary'){
        progress=(state.totalQ/50)*100;
        $("levelProgress").textContent="";
    }else if(state.mode==='hidden'){
        progress=(state.hiddenQ/10)*100;
        $("levelProgress").textContent="";
    }else if(state.mode==='select'){
        progress=(state.selectCorrectCount/10)*100;
        $("levelProgress").textContent=`ÈÄ£Á∂öÊ≠£Ëß£: ${state.selectCorrectCount}/10Âïè`;
    }
    
    progressBar.style.width=progress+"%";
}

function newProblem(){
    state.prob=generateProblem(state.level);
    state.unit=state.prob.u||"";
    $("q").innerHTML=state.prob.q;
    $("monster").textContent=monsters[state.level-1];
    $("lv").textContent=state.level;
    $("lvInfo").textContent=lvNames[state.level-1];
    
    // Âçò‰ΩçË°®Á§∫„ÅÆÊõ¥Êñ∞
    if(state.unit){
        $("fUnit").textContent=state.unit;
        $("mUnit").textContent=state.unit;
        $("nUnit").textContent=state.unit;
        $("fUnit").style.display="block";
        $("mUnit").style.display="block";
        $("nUnit").style.display="block";
    }else{
        $("fUnit").style.display="none";
        $("mUnit").style.display="none";
        $("nUnit").style.display="none";
    }
    
    // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„ÇØ„É™„Ç¢
    $("n").value="";
    $("d").value="";
    $("mw").value="";
    $("mn").value="";
    $("md").value="";
    $("norm").value="";
    $("f1n").value="";
    $("f1d").value="";
    $("operator").value="";
    $("f2n").value="";
    $("f2d").value="";
    
    // Ë°®Á§∫„ÅÆÂà∂Âæ°
    if(state.prob.type==='comparison'){
        $("answerSections").style.display="none";
        $("formulaSection").style.display="none";
        $("comparisonInput").style.display="block";
        state.selectedComparison=null;
        document.querySelectorAll('.comparison-btn').forEach(btn=>btn.classList.remove('selected'));
    }else if(state.prob.type==='formula'){
        $("answerSections").style.display="none";
        $("comparisonInput").style.display="none";
        $("formulaSection").style.display="flex";
        updateFormulaPreview();
    }else{
        $("answerSections").style.display="flex";
        $("formulaSection").style.display="none";
        $("comparisonInput").style.display="none";
        $("mixedSection").style.display=state.prob.mixed?"block":"none";
    }
    
    $("wrong").style.display="none";
    
    // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíÈÅ©Âàá„Å™ÂÖ•ÂäõÊ¨Ñ„Å´Ë®≠ÂÆö
    setTimeout(() => {
        if(state.prob.type==='formula'){
            $("f1n").focus();
        }else if(state.prob.type!=='comparison'){
            $("d").focus();
        }
    }, 100);
}

// ÊÆã„Çä„ÅÆÈñ¢Êï∞„ÅØÂâçÂõûÂá∫Âäõ„Åó„Åü„Ç≥„Éº„Éâ„Å®Âêå„Åò„Åß„Åô...
function submitFormula(){
    const f1n=parseInt($("f1n").value);
    const f1d=parseInt($("f1d").value);
    const operator=$("operator").value;
    const f2n=parseInt($("f2n").value);
    const f2d=parseInt($("f2d").value);
    
    if(isNaN(f1n)||isNaN(f1d)||!operator||isNaN(f2n)||isNaN(f2d)){
        alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    const correct=state.prob.correctFormula;
    if(f1n===correct.n1&&f1d===correct.d1&&operator===correct.op&&f2n===correct.n2&&f2d===correct.d2){
        handleCorrect();
    }else{
        handleWrong(`${correct.n1}/${correct.d1} ${correct.op} ${correct.n2}/${correct.d2}`);
    }
}

function selectComparison(btn,choice){
    document.querySelectorAll('.comparison-btn').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    state.selectedComparison=choice;
}

function submitComparison(){
    if(!state.selectedComparison){
        alert('ÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    let correct=false;
    const questionType=state.prob.questionType||"Â§ß„Åç„ÅÑ";
    
    if(questionType==="Â§ß„Åç„ÅÑ"){
        if(state.selectedComparison==='left'&&state.prob.left>state.prob.right)correct=true;
        if(state.selectedComparison==='right'&&state.prob.left<state.prob.right)correct=true;
        if(state.selectedComparison==='equal'&&state.prob.left===state.prob.right)correct=true;
    }else{
        if(state.selectedComparison==='left'&&state.prob.left<state.prob.right)correct=true;
        if(state.selectedComparison==='right'&&state.prob.left>state.prob.right)correct=true;
        if(state.selectedComparison==='equal'&&state.prob.left===state.prob.right)correct=true;
    }
    
    if(correct){
        handleCorrect();
    }else{
        let correctAnswer;
        if(questionType==="Â§ß„Åç„ÅÑ"){
            correctAnswer=state.prob.left>state.prob.right?'Â∑¶„Åå„Çè':
                         state.prob.left<state.prob.right?'Âè≥„Åå„Çè':'Âêå„Åò';
        }else{
            correctAnswer=state.prob.left<state.prob.right?'Â∑¶„Åå„Çè':
                         state.prob.left>state.prob.right?'Âè≥„Åå„Çè':'Âêå„Åò';
        }
        handleWrong(correctAnswer);
    }
}

function submitFraction(){
    const n=parseInt($("n").value);
    const d=parseInt($("d").value);
    if(isNaN(n)||isNaN(d)||d<=0){
        alert('Ê≠£„Åó„ÅÑÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    checkFractionAnswer(n,d);
}

function submitMixed(){
    const w=parseInt($("mw").value)||0;
    const n=parseInt($("mn").value)||0;
    const d=parseInt($("md").value);
    if(isNaN(d)||d<=0){
        alert('Ê≠£„Åó„ÅÑÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    const improperN=w*d+n;
    checkFractionAnswer(improperN,d);
}

function submitNormal(){
    const input=$("norm").value.trim();
    if(!input){
        alert('Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    let userAnswer;
    if(input.includes('/')){
        const parts=input.split('/');
        if(parts.length!==2){
            alert('ÂàÜÊï∞„ÅØ„ÄåÂàÜÂ≠ê/ÂàÜÊØç„Äç„ÅÆÂΩ¢„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        const n=parseInt(parts[0]);
        const d=parseInt(parts[1]);
        if(isNaN(n)||isNaN(d)||d<=0){
            alert('Ê≠£„Åó„ÅÑÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        checkFractionAnswer(n,d);
        return;
    }else{
        userAnswer=parseFloat(input);
        if(isNaN(userAnswer)){
            alert('Ê≠£„Åó„ÅÑÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
    }
    
    const[correctN,correctD]=simplify(state.prob.n,state.prob.d);
    const correctDecimal=correctN/correctD;
    
    if(Math.abs(userAnswer-correctDecimal)<0.001){
        handleCorrect();
    }else{
        handleWrong(formatAnswer(state.prob.n,state.prob.d,state.unit));
    }
}

function checkFractionAnswer(userN,userD){
    const[correctN,correctD]=simplify(state.prob.n,state.prob.d);
    
    // Á¥ÑÂàÜ„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    const userGcd = gcd(Math.abs(userN), Math.abs(userD));
    
    if(userGcd > 1){
        // Á¥ÑÂàÜ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÈñìÈÅï„ÅÑ„Å®„Åó„Å¶Êâ±„ÅÜ
        const[simplifiedN,simplifiedD]=simplify(userN,userD);
        $("almostMsg").style.display="block";
        $("almostText").textContent=`${userN}/${userD} „ÅØÁ¥ÑÂàÜ„Åô„Çã„Å® ${simplifiedN}/${simplifiedD} „Å´„Å™„Çä„Åæ„Åô`;
        $("correctAnswer").style.display="block";
        $("correctText").textContent=formatAnswer(state.prob.n,state.prob.d,state.unit);
        $("wrong").style.display="block";
        return;
    }
    
    // Á¥ÑÂàÜ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÊ≠£Ëß£Âà§ÂÆö
    if(userN===correctN&&userD===correctD){
        handleCorrect();
    }else{
        handleWrong(formatAnswer(state.prob.n,state.prob.d,state.unit));
    }
}

async function handleCorrect(){
    state.score++;
    $("score").textContent=state.score;
    
    const points=calculateCorrectPoints(state.level,state.mode);
    await addPoints(points);
    
    $("monster").classList.add("correct");
    setTimeout(()=>$("monster").classList.remove("correct"),1500);
    
    if(state.mode==='practice'){
        state.lvCount++;
        if(state.lvCount>=5){
            state.completed.add(state.level);
            const levelPoints=calculateLevelPoints(state.level,state.mode);
            await addPoints(levelPoints);
            
            $("monster").classList.add("level-up");
            setTimeout(()=>$("monster").classList.remove("level-up"),3000);
            
            if(state.level<10){
                state.level++;
                state.lvCount=0;
            }else{
                setTimeout(()=>{
                    alert('Á∑¥Áøí„É¢„Éº„ÉâÂÖ®„É¨„Éô„É´ÂÆå‰∫ÜÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ');
                    backToStart();
                },2000);
                return;
            }
        }
    }else if(state.mode==='summary'){
        state.totalQ++;
        if(state.totalQ>=50){
            stopTimer();
            const clearTime=getElapsedTime();
            enableHiddenStage();
            setTimeout(()=>showClear(clearTime),1000);
            return;
        }else if(state.totalQ%5===0){
            state.level++;
        }
    }else if(state.mode==='hidden'){
        state.hiddenQ++;
        if(state.hiddenQ>=10){
            stopTimer();
            setTimeout(()=>showHiddenClear(),1000);
            return;
        }
    }else if(state.mode==='select'){
        state.selectQCount++;
        state.selectCorrectCount++;
        
        // 10ÂïèÈÄ£Á∂öÊ≠£Ëß£„Åß„É¨„Éô„É´„ÇØ„É™„Ç¢
        if(state.selectCorrectCount>=10){
            state.clearedLevels.add(state.level);
            saveClearedLevels();
            
            const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
            await addPoints(levelClearPoints);
            
            setTimeout(()=>showLevelClear(),1000);
            return;
        }
    }
    
    updateLevelIndicator();
    updateProgressBar();
    setTimeout(newProblem,1500);
}

function handleWrong(correctAnswer){
    $("almostMsg").style.display="none";
    $("correctAnswer").style.display="block";
    $("correctText").textContent=correctAnswer;
    
    if(state.mode==='practice'){
        $("practiceMsg").style.display="block";
        $("selectMsg").style.display="none";
        $("backToSelectBtn").style.display="none";
        state.lvCount=0;
    }else if(state.mode==='summary'||state.mode==='hidden'){
        stopTimer();
        const finalTime=getElapsedTime();
        setTimeout(()=>showGameOver(finalTime),2000);
        return;
    }else{
        $("practiceMsg").style.display="none";
        $("selectMsg").style.display="block";
        $("backToSelectBtn").style.display="inline-block";
        state.selectCorrectCount=0;
    }
    
    $("monster").classList.add("wrong");
    setTimeout(()=>$("monster").classList.remove("wrong"),1000);
    $("wrong").style.display="block";
    updateProgressBar();
}

function retry(){
    $("wrong").style.display="none";
    newProblem();
}

function next(){
    $("wrong").style.display="none";
    newProblem();
}

async function showGameOver(finalTime){
    $("game").style.display="none";
    $("gameover").style.display="block";
    $("finalLv").textContent=state.level;
    $("finalScore1").textContent=state.score;
    
    if(state.mode==='summary'||state.mode==='hidden'){
        $("finalTime").style.display="block";
        $("finalTimeValue").textContent=formatTime(finalTime);
        
        if(state.score > 0){
            const gameoverPoints=state.level*20;
            $("gameoverPoints").style.display="block";
            $("gameoverPointsValue").textContent=gameoverPoints;
            await addPoints(gameoverPoints);
        }
        
        displayGlobalRanking('#globalRankingGameover','#myGlobalRankGameover');
    }
}

async function showClear(clearTime){
    $("game").style.display="none";
    $("clear").style.display="block";
    $("finalScore2").textContent=state.score;
    $("clearTimeValue").textContent=formatTime(clearTime);
    
    const clearPoints=calculateClearPoints(clearTime);
    $("pointsEarned").style.display="block";
    $("earnedPoints").textContent=clearPoints;
    await addPoints(clearPoints);
    
    try{localStorage.setItem('summaryCleared','true')}catch(e){}
    
    createFireworks();
    displayGlobalRanking('#globalRankingClear','#myGlobalRankClear');
    
    $("hiddenStageUnlock").style.display="block";
}

async function showLevelClear(){
    $("game").style.display="none";
    $("levelClear").style.display="block";
    $("clearedLevel").textContent=state.level;
    
    const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
    $("levelClearPointsValue").textContent=levelClearPoints;
    
    createFireworks();
}

async function showHiddenClear(){
    $("game").style.display="none";
    $("hiddenClear").style.display="block";
    $("hiddenFinalScore").textContent=state.score;
    
    createMasterFireworks();
    unlockTitle('divisionMaster');
    
    const hiddenPoints=3000;
    $("hiddenPointsEarned").style.display="block";
    $("hiddenEarnedPoints").textContent=hiddenPoints;
    await addPoints(hiddenPoints);
    
    displayGlobalRanking('#globalRankingHidden','#myGlobalRankHidden');
}

function restart(){
    state.sessionPoints=0;
    backToStart();
}

function createFireworks(){
    const celebration=$("celebration");
    celebration.innerHTML="";
    
    for(let i=0;i<20;i++){
        const firework=document.createElement("div");
        firework.className="firework";
        firework.style.left=Math.random()*100+"%";
        firework.style.top=Math.random()*100+"%";
        firework.style.animationDelay=Math.random()*2+"s";
        celebration.appendChild(firework);
        
        setTimeout(()=>firework.remove(),3000);
    }
    
    for(let i=0;i<50;i++){
        const sparkle=document.createElement("div");
        sparkle.className="sparkle";
        sparkle.style.left=Math.random()*100+"%";
        sparkle.style.top=Math.random()*100+"%";
        sparkle.style.animationDelay=Math.random()*3+"s";
        celebration.appendChild(sparkle);
        
        setTimeout(()=>sparkle.remove(),4000);
    }
}

function createMasterFireworks(){
    const celebration=$("celebration");
    celebration.innerHTML="";
    
    for(let i=0;i<50;i++){
        const firework=document.createElement("div");
        firework.className="firework";
        firework.style.left=Math.random()*100+"%";
        firework.style.top=Math.random()*100+"%";
        firework.style.animationDelay=Math.random()*3+"s";
        firework.style.background=`hsl(${Math.random()*360},100%,50%)`;
        celebration.appendChild(firework);
        
        setTimeout(()=>firework.remove(),5000);
    }
    
    for(let i=0;i<100;i++){
        const sparkle=document.createElement("div");
        sparkle.className="sparkle";
        sparkle.style.left=Math.random()*100+"%";
        sparkle.style.top=Math.random()*100+"%";
        sparkle.style.animationDelay=Math.random()*5+"s";
        sparkle.style.background=`hsl(${Math.random()*360},100%,70%)`;
        celebration.appendChild(sparkle);
        
        setTimeout(()=>sparkle.remove(),6000);
    }
}

function unlockTitle(titleKey){
    if(titles[titleKey]){
        titles[titleKey].unlocked=true;
        try{localStorage.setItem('titles',JSON.stringify(titles))}catch(e){}
    }
}

try{
    if(localStorage.getItem('summaryCleared')==='true'){
        enableHiddenStage();
    }
}catch(e){}

document.addEventListener('keydown',function(e){
    if(e.key==='Enter'&&$("game").style.display==="block"){
        if($("comparisonInput").style.display==="block"){
            submitComparison();
        }else if($("formulaSection").style.display==="flex"){
            submitFormula();
        }else if($("n").value&&$("d").value){
            submitFraction();
        }else if($("norm").value){
            submitNormal();
        }
    }
});
</script>
</body>
</html>
